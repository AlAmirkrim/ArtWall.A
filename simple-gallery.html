<!-- simple-gallery.html -->
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معرض صور بسيط</title>
    <link rel="stylesheet" href="unified-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <script src="imageData.js"></script>
    <script src="shared-image-utilities.js"></script>
    <script src="ImageDownloader.js"></script>
    <script src="language-functions.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1a0b20;
            color: white;
            margin: 0;
            padding: 0;
        }
        
        /* تنسيق هيدر الموقع */
        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(13, 0, 13, 0.95);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            padding: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .header-left {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1002;
            width: auto;
        }
        
        .header-right {
            position: fixed;
            right: 15px;
            top: 10px;
            z-index: 1005;
        }
        
        .site-logo-container {
            display: flex;
            align-items: center;
            height: 100%;
            direction: ltr;
        }
        
        .header-logo-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .site-name-small {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 1px;
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #b14cc8, #4CAF50, #00e6ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .site-name-small:hover {
            transform: scale(1.05);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        
        /* تنسيق زر القائمة */
        .menu-toggle {
            background: rgba(64, 16, 75, 0.7);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .menu-toggle:hover {
            background: rgba(84, 21, 100, 0.9);
        }
        
        .menu-toggle i {
            color: white;
            font-size: 1.2rem;
        }
        
        /* تنسيق القائمة الجانبية */
        .sidebar {
            width: 220px; /* تصغير العرض من 240px إلى 220px */
            height: 100vh;
            background: rgba(13, 0, 13, 0.95);
            position: fixed;
            left: -255px; /* تعديل موضع الإخفاء ليتوافق مع العرض الجديد */
            top: 0;
            padding-top: 70px;
            padding-left: 1rem; /* تقليل padding من 1.2rem إلى 1rem */
            padding-right: 1rem;
            padding-bottom: 2rem;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            z-index: 900;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            overflow-x: hidden;
            /* إخفاء شريط التمرير مع الاحتفاظ بوظيفة التمرير */
            scrollbar-width: none; /* لمتصفحات Firefox */
            -ms-overflow-style: none; /* لمتصفحات Edge/IE */
            /* ضمان ثبات موضع القائمة الجانبية بغض النظر عن اللغة */
            direction: ltr;
        }
        
        /* إخفاء شريط التمرير لمتصفحات WebKit (Chrome, Safari) */
        .sidebar::-webkit-scrollbar {
            width: 0;
            display: none;
        }
        
        /* ضبط اتجاه محتوى القائمة بناءً على اللغة */
        html[dir="rtl"] .sidebar .account-section {
            text-align: right;
        }
        
        html[dir="ltr"] .sidebar .account-section {
            text-align: left;
        }
        
        .sidebar.active {
            left: 0;
            transform: translateX(0);
        }
        
        /* تنسيق القائمة في الشاشات الصغيرة */
        @media (max-width: 768px) {
            .sidebar {
                left: -260px; /* تعديل موضع الإخفاء ليناسب الشاشات الصغيرة */
                transform: translateX(-100%);
                width: 230px; /* تقليل العرض من 250px إلى 230px */
                z-index: 900;
            }
            
            .sidebar.active {
                left: 0;
                transform: translateX(0);
            }
            
            .header-right {
                right: 10px;
            }
            
            .site-name-small {
                font-size: 1.1rem;
            }
            
            .header-logo-small {
                width: 32px;
                height: 32px;
            }
        }
        
        @media (max-width: 480px) {
            .header-right {
                right: 5px;
            }
            
            .site-name-small {
                font-size: 1rem;
            }
            
            .header-logo-small {
                width: 28px;
                height: 28px;
            }
            
            /* تعديلات إضافية للشاشات الصغيرة جدًا */
            .site-header {
                padding: 5px 10px;
                height: 55px;
            }
            
            .filters-container {
                top: 55px;
                padding: 5px 0;
            }
            
            .filters {
                padding: 6px 10px;
                max-width: 98%;
                border-radius: 20px;
                margin-bottom: 10px;
            }
            
            .filter-btn {
                padding: 5px 10px;
                font-size: 13px;
            }
            
            .language-switcher {
                top: 10px;
                padding: 3px 8px;
            }
            
            .dimensions-buttons {
                justify-content: space-around;
            }
            
            /* تصغير أزرار طريقة العرض في الشاشات الصغيرة */
            .view-mode-btn {
                width: 40px;
                height: 40px;
            }
            
            /* تعديل مربع البحث */
            .search-container {
                margin: 8px auto;
                max-width: 70%;
                width: 65%;
            }
            
            /* تصغير حجم الصور في الشاشات الصغيرة في وضع العرض الثاني */
            body.wide-view .grid-item {
                max-width: 92%;
                margin: 0 auto 15px;
                transform: scale(0.92);
                transform-origin: top center;
            }
            
            body.wide-view .grid-item img {
                max-width: 100%;
                height: auto;
            }
            
            html[dir="rtl"] .search-input {
                padding: 5px 8px 5px 25px;
                font-size: 11px;
                height: 28px;
            }
            
            html[dir="ltr"] .search-input {
                padding: 5px 25px 5px 8px;
                font-size: 11px;
                height: 28px;
            }
            
            /* تعديل أزرار الإجراءات في الصور */
            .action-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }
        
        /* تنسيق شعار الموقع في القائمة */
        .logo-section {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .sidebar-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 10px;
        }
        
        /* تنسيق قسم الحساب */
        .account-section {
            margin-bottom: 12px; /* تقليل المساحة السفلية */
        }
        
        .account-section h3 {
            font-size: 1.1rem; /* تقليل حجم الخط */
            color: #b14cc8;
            margin-bottom: 12px; /* تقليل المساحة السفلية */
            padding-bottom: 4px; /* تقليل المساحة السفلية للخط */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* تنسيق معلومات المستخدم */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* تنسيق أزرار التنقل */
        .auth-btn {
            background-color: rgba(58, 16, 69, 0.5);
            color: white;
            border: none;
            padding: 8px 12px; /* تقليل حجم التباعد الداخلي */
            border-radius: 5px;
            margin-bottom: 8px; /* تقليل المسافة بين الأزرار */
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            text-align: right;
            display: flex;
            align-items: center;
            font-size: 0.95rem; /* تقليل حجم الخط قليلاً */
        }
        
        .auth-btn:hover {
            background-color: rgba(177, 76, 200, 0.7);
        }
        
        /* تنسيق قسم أبعاد الصور */
        .dimensions-section {
            margin-top: 10px; /* تقليل المسافة بين الأقسام */
            margin-bottom: 10px; /* تقليل المسافة أسفل الأقسام */
        }
        
        .dimensions-title {
            font-size: 1rem; /* تقليل حجم العنوان */
            color: #b14cc8;
            margin-bottom: 6px; /* تقليل المسافة بين العنوان والمحتوى */
        }
        
        /* نمط للمساحة الفارغة أسفل القائمة */
        .sidebar-spacer {
            height: 150px; /* زيادة ارتفاع المساحة الفارغة لضمان ظهور أيقونة القلب */
            padding-top: 10px;
            margin-top: 15px;
            padding-bottom: 50px; /* إضافة مساحة إضافية أسفل لضمان التمرير */
            position: relative;
            /* إضافة تأثير تلاشي على الحافة */
            background: linear-gradient(to bottom, rgba(13, 0, 13, 0.95), transparent);
        }
        
        /* تنسيق أيقونة القلب في نهاية القائمة */
        .heart-icon {
            position: absolute;
            bottom: 25px; /* زيادة المسافة من الأسفل */
            left: 50%;
            transform: translateX(-50%);
            color: #b14cc8;
            font-size: 26px; /* زيادة حجم الأيقونة */
            opacity: 0.8;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            z-index: 10; /* تأكيد ظهور الأيقونة فوق العناصر الأخرى */
            pointer-events: auto; /* تمكين التفاعل مع الأيقونة */
        }
        
        .heart-icon:hover {
            opacity: 1;
            transform: translateX(-50%) scale(1.2);
            color: #ff4e8a;
        }
        
        .dimensions-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px; /* تقليل المسافة بين الأزرار */
        }
        
        .dimension-btn {
            background-color: rgba(58, 16, 69, 0.5);
            border: none;
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s;
            width: 60px;  /* إعادة إلى الحجم الأصلي */
            height: 60px; /* إعادة إلى الحجم الأصلي */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px; /* تقليل المسافة بين الأزرار */
        }

        .dimension-btn.dimension-btn3 {
            background-color: rgba(58, 16, 69, 0.5);
            border: none;
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.3s;
            width: 35px;  /* إعادة إلى الحجم الأصلي */
            height: 60px; /* إعادة إلى الحجم الأصلي */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px; /* تقليل المسافة بين الأزرار */
        }
        
        .dimension-btn:hover {
            background-color: rgba(177, 76, 200, 0.7);
            transform: translateY(-2px);
        }
        
        .dimension-btn.active {
            background-color: #b14cc8;
            box-shadow: 0 0 10px rgba(177, 76, 200, 0.7);
        }
        
        /* تنسيق عام للصور داخل الأزرار */
        .dimension-btn img {
            width: 99%;
            height: 99%;
            object-fit: contain;
        }
        
        /* تنسيق خاص لزر الـ All (جعل الصورة أكبر) */
        .dimension-btn.dimension-btn-all img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: block;
            max-width: 54px;
            height: auto;
        }
        
        /* تنسيق خاص للأزرار الثلاثة الأخرى */
        .dimension-btn:not(.dimension-btn-all) img {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            display: block;
            max-width: 32px;
            height: auto;
        }
        
        /* تنسيق أزرار طريقة العرض */
        .view-mode-btn {
            background-color: rgba(58, 16, 69, 0.5);
            border: none;
            border-radius: 8px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s;
            width: 60px;  /* تعديل ليتناسب مع أزرار الأبعاد */
            height: 60px; /* تعديل ليتناسب مع أزرار الأبعاد */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            font-size: 1.2rem; /* زيادة حجم الأيقونات */
        }
        
        .view-mode-btn:hover {
            background-color: rgba(177, 76, 200, 0.7);
            transform: translateY(-2px);
        }
        
        .view-mode-btn.active {
            background-color: #b14cc8;
            box-shadow: 0 0 10px rgba(177, 76, 200, 0.7);
        }
        
        /* تنسيق المحتوى الرئيسي */
        .main-content {
            padding-top: 80px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        /* تحسين العرض في الشاشات الكبيرة مع القائمة */
        @media (min-width: 1200px) {
            .main-content {
                margin-left: 260px; /* عرض القائمة + مسافة 30px */
                width: calc(100% - 235px);
                padding-left: 0; /* إزالة الهامش الداخلي الإضافي */
            }
            
            body.sidebar-expanded .main-content {
                margin-left: 245px;
            }
            
            /* تعيين المسافة بين القائمة والمحتوى لتكون أكبر قليلاً من المسافة بين الصور */
            .gallery-container {
                padding-left: 25px; /* مسافة أكبر من gutter-sizer */
            }
        }
        
        /* تحسين المسافة بين القائمة وعناصر الصفحة في الشاشات متوسطة الحجم */
        @media (min-width: 768px) and (max-width: 1199px) {
            .main-content {
                padding-top: 85px; /* زيادة المسافة من الأعلى */
            }
            
            .gallery-container {
                padding-left: 35px; /* زيادة المسافة على اليسار */
                padding-right: 35px; /* زيادة المسافة على اليمين */
            }
            
            body.sidebar-expanded .main-content {
                margin-left: 40px; /* مسافة إضافية عندما تكون القائمة الجانبية مفتوحة */
            }
        }
        
        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* تنسيق قسم المعرض */
        .masonry-grid {
            width: 100%;
        }
        
        .grid-sizer,
        .grid-item {
            width: calc(33.333% - 10px);
            margin-bottom: 15px;
        }
        
        /* تنسيقات CSS متغيرة لتطبيق العرض وفق الاختيارات */
        :root {
            --grid-columns: 3;
            --medium-columns: 2;
            --small-columns: 1;
        }
        
        /* تنسيق خاص للشاشات المتوسطة - الأجهزة اللوحية (769px - 1199px) */
        @media (min-width: 769px) and (max-width: 1199px) {
            /* الوضع الافتراضي: عمودان باستخدام Masonry */
            .grid-sizer,
            .grid-item {
                width: calc(50% - 10px);
                margin-bottom: 15px;
            }
            
            /* الوضع العريض: ثلاثة أعمدة */
            body.wide-view .grid-sizer,
            body.wide-view .grid-item {
                width: calc(33.33% - 10px);
            }
        }
        
        @media (max-width: 768px) {
            .grid-sizer,
            .grid-item {
                width: calc((100% / var(--medium-columns)) - 7.5px) !important;
            }
            
            .gallery-container {
                padding: 0 10px;
            }
            
            .gutter-sizer {
                width: 10px;
            }
            
            /* تعديل هوامش عناصر المعرض */
            .image-card {
                margin-bottom: 12px;
            }
            
            /* تقليص حجم نص العنوان */
            .image-title-badge {
                max-width: 120px;
                font-size: 11px;
            }
            
            /* تصغير زر عرض الصورة */
            .action-btn {
                width: 32px;
                height: 32px;
            }
        }
        
        @media (max-width: 480px) {
            .grid-sizer,
            .grid-item {
                width: calc((100% / var(--small-columns)) - 5px) !important;
            }
            
            /* تحسينات إضافية للوضع العريض بالنسبة للشاشات الصغيرة */
            body.wide-view .grid-sizer {
                width: 50% !important;
            }
            
            body.wide-view .grid-item {
                width: calc(50% - 5px) !important;
                float: left !important;
                margin-right: 5px;
            }
            
            /* تحسين العرض في الوضع العريض للشاشات الصغيرة - عمودين */
            body.wide-mobile-view .masonry-grid {
                display: block !important;
                column-count: 2 !important;
                column-gap: 6px !important;
            }
            
            /* تحسين عرض الصور في الوضع العريض للشاشات الصغيرة */
            body.wide-mobile-view .image-card {
                display: inline-block !important;
                width: 100% !important;
                margin-bottom: 6px !important;
                break-inside: avoid !important;
            }
            
            /* تعديل عناصر Grid للشاشات الصغيرة */
            body.wide-mobile-view .grid-item {
                width: 100% !important;
                margin: 0 0 6px 0 !important;
                break-inside: avoid !important;
            }
            
            /* تنظيف التدفق بعد كل زوج من العناصر */
            body.wide-mobile-view .grid-item:nth-child(2n)::after,
            body.wide-view .grid-item:nth-child(2n)::after {
                content: "";
                display: table;
                clear: both;
            }
            
            /* فئة خاصة للشبكة في الوضع العريض */
            .wide-grid {
                display: flex !important;
                flex-wrap: wrap !important;
                width: 100% !important;
            }
            
            .gallery-container {
                padding: 0 8px;
            }
            
            .image-card {
                margin-bottom: 15px;
                width: 100%;
                display: block;
                break-inside: avoid;
            }
            
            /* ضبط حجم بطاقات الصور على الشاشات الصغيرة */
            body.wide-view .image-card,
            body.wide-mobile-view .image-card {
                margin-bottom: 6px;
                height: auto; /* إصلاح ارتفاع الصور */
            }
            
            /* جعل أزرار الإجراءات السفلية ظاهرة دائمًا في الهواتف الصغيرة */
            .bottom-actions {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }
            
            /* تعديل حجم وترتيب الأزرار للشاشات الصغيرة */
            .action-btn {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            /* تعديل ترتيب الأزرار والشارات للشاشات الصغيرة */
            .image-header {
                top: 5px;
                right: 5px;
                gap: 3px;
            }
            
            .category-badge {
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .image-title-badge {
                font-size: 10px;
                padding: 3px 6px;
                max-width: 100px;
            }
            
            /* تحسين أداء العرض في الشاشات الصغيرة */
            .image-card:hover {
                transform: translateY(-2px);
            }
            
            /* تعديل الفلاتر وشريط البحث في الشاشات الصغيرة */
            .filters {
                padding: 8px 12px;
                border-radius: 20px;
                max-width: 95%;
                gap: 6px;
            }
            
            .filter-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        
        .gutter-sizer {
            width: 15px;
        }
        
        /* تنسيق الصور */
        .image-card {
            border-radius: 8px;
            overflow: hidden;
            background-color: #2a0a30;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            position: relative;
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
        }
        
        .gallery-image {
            width: 100%;
            display: block;
            object-fit: cover; /* تأكد من تغطية مساحة الصورة بالكامل */
            height: calc(100% - 10px); /* ضبط ارتفاع الصورة لتقليل المسافات الفارغة */
            min-height: 150px; /* حد أدنى للارتفاع */
        }
        
        /* تنسيق معلومات الصورة */
        .image-header {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 5;
        }
        
        .category-badge {
            background-color: rgba(177, 76, 200, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            backdrop-filter: blur(2px);
        }
        
        .image-title-badge {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            backdrop-filter: blur(2px);
        }
        
        /* تنسيق الأزرار في يسار الصورة */
        .left-actions {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 5px; /* تقليل المسافة بين زر العرض وعدد الإعجابات */
            z-index: 5;
        }
        
        /* تنسيق الأزرار في أسفل الصورة - مخفية وتظهر عند المرور بالماوس */
        .bottom-actions {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 5;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            border-radius: 20px;
        }
        
        .image-card:hover .bottom-actions {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        /* تنسيق أزرار الصورة */
        .action-btn {
            background-color: rgba(58, 16, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(2px);
        }
        
        .action-btn:hover {
            background-color: #b14cc8;
            transform: scale(1.1);
        }
        
        /* تنسيق زر الإعجاب */
        .action-btn.like-btn .fa-heart {
            color: transparent;
            -webkit-text-stroke: 1px white;
            transition: all 0.3s;
        }
        
        .action-btn.like-btn.active .fa-heart {
            color: white;
            -webkit-text-stroke: 0;
        }
        
        /* تنسيق زر المفضلة */
        .action-btn.favorite-btn .fa-bookmark {
            color: transparent;
            -webkit-text-stroke: 1px white;
            transition: all 0.3s;
        }
        
        .action-btn.favorite-btn.active .fa-bookmark {
            color: white;
            -webkit-text-stroke: 0;
        }
        
        /* تنسيق عداد الإعجابات */
        .like-count {
            font-size: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 10px;
            padding: 2px 5px;
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 20px;
            text-align: center;
        }
        
        /* تنسيق تأثير النبض */
        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* تنسيق أزرار طريقة العرض */
        .view-mode-btn {
            background-color: rgba(58, 16, 69, 0.5);
            border: none;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            font-size: 18px;
            color: white;
        }
        
        .view-mode-btn:hover {
            background-color: rgba(177, 76, 200, 0.7);
            transform: translateY(-2px);
        }
        
        .view-mode-btn.active {
            background-color: #b14cc8;
            box-shadow: 0 0 10px rgba(177, 76, 200, 0.7);
        }
        
        /* تنسيق أزرار الفلترة */
        .filters-container {
            position: sticky;
            top: 70px;
            z-index: 800;
            padding: 10px 0;
            background-color: transparent;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        .filters {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px 15px;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none; /* إخفاء شريط التمرير في Firefox */
            background-color: rgba(13, 0, 13, 0.9);
            border-radius: 30px;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            -ms-overflow-style: none; /* إخفاء شريط التمرير في IE و Edge */
        }
        
        /* إخفاء شريط التمرير في Chrome و Safari و Opera */
        .filters::-webkit-scrollbar {
            display: none;
        }
        
        .filters::-webkit-scrollbar {
            height: 5px;
        }
        
        .filters::-webkit-scrollbar-track {
            background: rgba(26, 11, 32, 0.5);
            border-radius: 10px;
        }
        
        .filters::-webkit-scrollbar-thumb {
            background-color: #b14cc8;
            border-radius: 10px;
        }
        
        .filter-btn {
            background-color: #3a1045;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            font-weight: 500;
            min-width: fit-content;
        }
        
        .filter-btn:hover {
            background-color: #b14cc8;
            transform: translateY(-2px);
        }
        
        .filter-btn.active {
            background-color: #b14cc8;
            box-shadow: 0 0 8px #b14cc8;
        }
        
        /* تنسيق عارض الصورة بالحجم الكامل */
        .fullscreen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .viewer-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .viewer-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        
        .viewer-title {
            text-align: center;
            margin-top: 15px;
            font-size: 18px;
        }
        
        .close-btn {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* تنسيق أزرار تبديل اللغة في القائمة الجانبية */
        .language-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        
        .sidebar-lang-btn {
            display: flex;
            align-items: center;
            background-color: rgba(58, 16, 69, 0.5);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            text-align: right;
        }
        
        .sidebar-lang-btn:hover {
            background-color: rgba(177, 76, 200, 0.7);
            transform: translateY(-2px);
        }
        
        .sidebar-lang-btn.active {
            background-color: #b14cc8;
            box-shadow: 0 0 10px rgba(177, 76, 200, 0.7);
        }
        
        .lang-icon {
            font-size: 18px;
            margin-right: 8px;
        }
        
        .lang-name {
            flex: 1;
            text-align: right;
            white-space: nowrap;
        }
        
        html[dir="ltr"] .sidebar-lang-btn {
            text-align: left;
        }
        
        html[dir="ltr"] .lang-name {
            text-align: left;
        }
        
        /* تنسيق مربع البحث */
        .search-container {
            position: relative;
            margin: 15px auto;
            max-width: 450px; /* زيادة العرض لاستيعاب الزر الجديد */
            width: 80%;
            display: flex;
            align-items: center;
            gap: 10px; /* مسافة بين العناصر */
        }
        
        /* تنسيق حقل البحث متوافق مع اتجاه اللغة */
        .search-input {
            flex: 1; /* جعل حقل البحث يأخذ المساحة المتبقية */
            background-color: rgba(26, 11, 32, 0.7);
            border: 1px solid rgba(177, 76, 200, 0.5);
            border-radius: 25px;
            color: white;
            font-size: 13px;
            transition: all 0.3s;
            outline: none;
        }
        
        html[dir="rtl"] .search-input {
            padding: 10px 15px 10px 40px;
            text-align: right;
        }
        
        html[dir="ltr"] .search-input {
            padding: 10px 40px 10px 15px;
            text-align: left;
        }
        
        .search-input:focus {
            background-color: rgba(45, 20, 55, 0.9);
            border-color: #b14cc8;
            box-shadow: 0 0 10px rgba(177, 76, 200, 0.5);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* تموضع أيقونة البحث حسب اتجاه اللغة */
        html[dir="rtl"] .search-icon {
            position: absolute;
            top: 50%;
            left: 15px;
            right: auto;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }
        
        html[dir="ltr"] .search-icon {
            position: absolute;
            top: 50%;
            right: 15px;
            left: auto;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }
        
        /* تنسيق زر تفعيل/إلغاء تفعيل المرشحات */
        .filter-toggle-btn {
            background: linear-gradient(135deg, rgba(177, 76, 200, 0.8), rgba(0, 230, 255, 0.6));
            border: 1px solid rgba(177, 76, 200, 0.5);
            border-radius: 25px;
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            min-width: 80px;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .filter-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, rgba(177, 76, 200, 1), rgba(0, 230, 255, 0.8));
        }
        
        .filter-toggle-btn.active {
            background: linear-gradient(135deg, rgba(177, 76, 200, 1), rgba(0, 230, 255, 0.8));
            border-color: rgba(177, 76, 200, 0.8);
        }
        
        .filter-toggle-btn.inactive {
            background: linear-gradient(135deg, rgba(100, 100, 100, 0.6), rgba(60, 60, 60, 0.8));
            border-color: rgba(100, 100, 100, 0.5);
            opacity: 0.7;
        }
        
        .filter-toggle-btn.inactive:hover {
            background: linear-gradient(135deg, rgba(120, 120, 120, 0.8), rgba(80, 80, 80, 1));
        }
        
        .filter-toggle-btn i {
            font-size: 13px;
        }
        
        .filter-status-text {
            font-weight: 500;
            font-size: 11px;
        }
        
        /* تأثير بصري عندما يكون البحث منفصل عن المرشحات */
        .search-container.unlinked .search-input {
            border-color: rgba(255, 165, 0, 0.7);
            box-shadow: 0 0 5px rgba(255, 165, 0, 0.3);
        }
        
        /* تنسيقات قائمة اللغة المنسدلة المأخوذة من index.html */
        .sidebar-tools {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .language-dropdown {
            position: relative;
            display: block;
            width: 100%;
        }
        
        /* تصميم زر اللغة - متوافق مع التصميم المحسن في الصفحة الرئيسية */
        .lang-switcher-new {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(177, 76, 200, 0.7), rgba(0, 230, 255, 0.5));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-decoration: none;
            box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            width: 100%;
            justify-content: space-between;
        }
        
        .lang-switcher-new:hover {
            background: linear-gradient(135deg, rgba(177, 76, 200, 0.9), rgba(0, 230, 255, 0.7));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .lang-switcher-new:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }
        
        .lang-icon {
            font-size: 1.1em;
            margin-right: 6px;
        }
        
        html[dir="rtl"] .lang-icon {
            margin-right: 0;
            margin-left: 6px;
        }
        
        /* تنسيق السهم في زر اللغة - محسن */
        .down-arrow {
            display: inline-block;
            margin-left: 6px;
            font-size: 0.8em;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* تدوير السهم عند فتح القائمة */
        .language-dropdown.open .down-arrow {
            transform: rotate(180deg);
        }
        
        /* تصميم محتوى القائمة المنسدلة للغة - موحد مع تصميم index.html */
        .language-dropdown-content {
            position: absolute;
            top: 100% !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            display: none; /* إخفاء القائمة افتراضياً */
            width: 200px; /* تقليل العرض ليتناسب مع القائمة الجانبية */
            max-width: 200px; /* ضمان عدم تجاوز العرض */
            background: rgba(26, 11, 32, 0.98);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 3px 10px rgba(177, 76, 200, 0.3);
            z-index: 9999;
            border: 2px solid rgba(177, 76, 200, 0.5);
            padding: 0;
            overflow: visible;
            /* سيتم تعيين الأنيميشن عبر JavaScript */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform, opacity;
        }
        
        /* أنيميشن للقائمة عند الظهور من أسفل */
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* أنيميشن للقائمة عند الظهور من أعلى */
        @keyframes fadeInFromTop {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* تم إزالة التأثير المتحرك وراء القائمة */
        
        /* تنسيق عرض القائمة المنسدلة عند النقر عليها */
        .language-dropdown-content.show {
            display: block !important; /* عرض القائمة عند الحاجة */
        }
        
        /* تصميم خيارات القائمة المنسدلة - محسن */
        .language-dropdown-content a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(177, 76, 200, 0.2);
            letter-spacing: 0.3px;
            width: 100%; /* ضمان عرض ثابت */
            direction: ltr; /* تثبيت اتجاه النص بغض النظر عن اتجاه الصفحة */
            justify-content: flex-start; /* محاذاة ثابتة */
            text-align: left; /* محاذاة النص ثابتة */
        }
        
        .language-dropdown-content a:last-child {
            border-bottom: none;
        }
        
        .language-dropdown-content a:hover {
            background-color: rgba(177, 76, 200, 0.3);
            padding-left: 18px;
            letter-spacing: 0.5px;
        }
        
        .language-dropdown-content a.active {
            background-color: rgba(177, 76, 200, 0.5);
            font-weight: bold;
        }
        
        .language-dropdown-content a::before {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .language-dropdown-content a[data-lang="ar"]::before {
            content: '🇸🇦';
        }
        
        .language-dropdown-content a[data-lang="en"]::before {
            content: '🇺🇸';
        }
        
        .language-dropdown-content a[data-lang="fr"]::before {
            content: '🇫🇷';
            margin-right: 10px;
        }
        
        .language-dropdown-content a[data-lang="es"]::before {
            content: '🇪🇸';
            margin-right: 10px;
        }
        
        .language-dropdown-content a.active::after {
            content: '✓';
            position: absolute;
            right: 15px;
            color: #4CAF50;
            font-weight: bold;
        }
        
        /* تثبيت موضع الأيقونات وعلامة الاختيار بغض النظر عن اتجاه اللغة */
        html[dir="rtl"] .language-dropdown-content a::before {
            margin-right: 10px;
            margin-left: 0;
        }
        
        html[dir="rtl"] .language-dropdown-content a.active::after {
            right: 15px;
            left: auto;
        }
        
        html[dir="rtl"] .language-dropdown-content {
            right: auto;
            left: 0; /* نحافظ على موضع القائمة */
            text-align: left; /* تثبيت محاذاة النص */
        }
        
        html[dir="rtl"] .language-dropdown-content a:hover {
            padding-left: 18px;
            padding-right: 15px;
        }
        
        /* أنماط أيقونات الفئات */
        .category-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.2em;
            vertical-align: middle;
            color: white;
        }
        
        .category-text {
            vertical-align: middle;
        }
        
        /* تخصيص للغة العربية (من اليمين إلى اليسار) */
        [dir="rtl"] .category-icon {
            margin-right: 0;
            margin-left: 8px;
        }
        
        /* تكبير حجم الأيقونة قليلاً للأزرار النشطة لإبرازها */
        .filter-btn.active .category-icon {
            font-size: 1.3em;
        }
        
        /* تحسين مظهر أزرار الفئات */
        .filter-btn {
            display: flex;
            align-items: center;
            padding: 8px 15px;
        }
        

        
        /* أنماط إشعار حالة الفلتر */
        #filter-status-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(58, 16, 69, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            max-width: 90%;
            width: auto;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(177, 76, 200, 0.3);
        }
        
        .filter-status-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-status-icon {
            font-size: 16px;
        }
        
        .filter-status-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .filter-status-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 0 0 10px;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- هيدر الموقع - واحد فقط -->
    <div class="site-header">
        <div class="header-left">
            <div class="site-logo-container">
                <img src="Imges/Leonardo_Anime_XL_A_futuristic_and_modern_logo_design_suitable_1 (1).jpg" alt="website logo" class="header-logo-small">
                <h1 class="site-name-small">ArtWall.A</h1>
            </div>
        </div>

        <div class="header-right">
            <div class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </div>

    <!-- الشريط الجانبي -->
    <div class="sidebar" id="sidebar">
        <div class="logo-section">
            <img src="Imges/Leonardo_Anime_XL_A_futuristic_and_modern_logo_design_suitable_1 (1).jpg" alt="website logo" class="sidebar-logo">
        </div>
        <div class="account-section">
            <h3 data-i18n="myAccount">حسابي</h3>
            <div id="user-info" style="display: flex; align-items: center; margin-bottom: 15px; width: 100%; position: relative; cursor: pointer;" onclick="toggleUserMenu()">
                <img id="user-avatar" src="Imges/Boy Cole _ Anime pictures .jpg" alt="User Avatar" class="user-avatar">
                <div style="flex: 1; min-width: 0; display: flex; justify-content: space-between; align-items: center;">
                    <span id="user-name" style="color: white; font-weight: bold; display: block !important; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; direction: ltr; text-align: left;"></span>
                    <span style="margin-left: 5px; margin-right: 5px;"><i class="fas fa-chevron-down" id="user-dropdown-icon"></i></span>
                </div>
                <!-- قائمة منسدلة للمستخدم -->
                <div id="user-dropdown-menu" class="user-dropdown-content" style="display: none;">
                    <a href="#" onclick="openSettings(); return false;" style="text-align: left; direction: ltr;">
                        <i class="fas fa-cog"></i> <span data-i18n="settings">الإعدادات</span>
                    </a>
                    <a href="#" onclick="logout(); return false;" style="text-align: left; direction: ltr;">
                        <i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">تسجيل الخروج</span>
                    </a>
                    <div class="user-dropdown-email" style="text-align: left; direction: ltr;">
                        <i class="fas fa-envelope"></i> <span id="user-email">user@example.com</span>
                    </div>
                </div>
            </div>
            
            <style>
                /* أنماط القائمة المنسدلة للمستخدم */
                .user-dropdown-content {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, rgba(25, 5, 30, 0.95), rgba(45, 15, 50, 0.95));
                    border: 1px solid rgba(255, 255, 255, 0.15);
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                    z-index: 100;
                    overflow: hidden;
                    width: 100%;
                    margin-top: 5px;
                }
                
                .user-dropdown-content a {
                    display: block;
                    padding: 12px 15px;
                    color: white;
                    text-decoration: none;
                    transition: background 0.3s;
                    font-size: 14px;
                }
                
                .user-dropdown-content a:hover {
                    background: rgba(255, 255, 255, 0.1);
                }
                
                .user-dropdown-email {
                    padding: 12px 15px;
                    color: rgba(255, 255, 255, 0.7);
                    font-size: 12px;
                    background: rgba(0, 0, 0, 0.2);
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    word-break: break-all;
                }
                
                #user-dropdown-icon {
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.7);
                    transition: transform 0.3s;
                }
                
                #user-info:hover #user-dropdown-icon {
                    color: white;
                }
            </style>
            <button class="auth-btn" onclick="window.location.href='simple-gallery.html'">
                <span style="margin-right: 8px;">🏠</span>
                <span data-i18n="home">الصفحة الرئيسية</span>
            </button>
            <button class="auth-btn" onclick="window.location.href='profile.html'">
                <span style="margin-right: 8px;">👤</span>
                <span data-i18n="myProfile">الملف الشخصي</span>
            </button>
            <button class="auth-btn" onclick="window.location.href='favorites.html'">
                <span style="margin-right: 8px;">♥</span>
                <span data-i18n="myFavorites">المفضلة</span>
            </button>
            
            <!-- قسم أبعاد الصور -->
            <div class="dimensions-section">
                <h3 class="dimensions-title" data-i18n="imageDimensions">أبعاد الصور</h3>
                <div class="dimensions-buttons">
                    <button class="dimension-btn dimension-btn-all active" data-dimension="all" onclick="filterByDimension('all')">
                        <img src="Imges/All img icon.png" alt="All" />
                    </button>
                    <button class="dimension-btn dimension-btn3" data-dimension="portrait" onclick="filterByDimension('portrait')">
                        <img src="Imges/length img icon 2;3.jpg" alt="2:3" />
                    </button>
                    <button class="dimension-btn dimension-btn3" data-dimension="square" onclick="filterByDimension('square')">
                        <img src="Imges/square img icon 1;1.jpg" alt="1:1" />
                    </button>
                    <button class="dimension-btn dimension-btn3" data-dimension="landscape" onclick="filterByDimension('landscape')">
                        <img src="Imges/an offer img icon 16;9.jpg" alt="16:9" />
                    </button>
                </div>
            </div>
            
            <!-- قسم طريقة العرض -->
            <div class="dimensions-section">
                <h3 class="dimensions-title" data-i18n="viewMode">طريقة العرض</h3>
                <div class="dimensions-buttons">
                    <button id="defaultViewBtn" class="view-mode-btn active" onclick="setGridColumnsWithSearch('default')">
                        <i class="fas fa-grip-vertical"></i>
                    </button>
                    <button id="wideViewBtn" class="view-mode-btn" onclick="setGridColumnsWithSearch('wide')" style="position: relative;">
                        <i class="fas fa-grip-horizontal"></i>
                        <i class="fas fa-ban mobile-disabled-icon" style="position: absolute; top: 2px; right: 2px; font-size: 10px; color: #ff6b6b; display: block;"></i>
                    </button>
                </div>
            </div>
            
            <!-- قسم الأدوات -->
            <div class="dimensions-section">
                <h3 class="dimensions-title" data-i18n="tools">أدوات</h3>
                <div class="sidebar-tools">
                    <div class="language-dropdown">
                        <button id="langToggleBtn" class="lang-switcher-new">
                            <span class="lang-icon">🌐</span>
                            <span data-i18n="language">اللغة</span> <span class="down-arrow">&#9660;</span>
                        </button>
                        <!-- قائمة اللغات المنسدلة -->
                        <div id="languageMenu" class="language-dropdown-content">
                            <a href="#" data-lang="ar" class="lang-option active" onclick="switchLanguage('ar')">العربية</a>
                            <a href="#" data-lang="en" class="lang-option" onclick="switchLanguage('en')">English</a>
                            <a href="#" data-lang="fr" class="lang-option lang-disabled" onclick="showLanguageTodo('fr')">Français</a>
                            <a href="#" data-lang="es" class="lang-option lang-disabled" onclick="showLanguageTodo('es')">Español</a>
                        </div>
                    </div>
                    
                    <!-- زر الإعدادات -->
                    <button id="settingsBtn" class="settings-btn" onclick="openSettings()">
                        <i class="fas fa-cog"></i>
                        <span data-i18n="settings">الإعدادات</span>
                    </button>
                    
                    <style>
                        .settings-btn {
                            display: flex;
                            align-items: center;
                            background: rgba(0, 0, 0, 0.2);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 10px 15px;
                            font-size: 14px;
                            cursor: pointer;
                            margin-top: 10px;
                            transition: all 0.3s ease;
                            width: 100%;
                            justify-content: flex-start;
                            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                            text-align: left;
                        }
                        
                        .settings-btn:hover {
                            background: rgba(80, 20, 95, 0.3);
                        }
                        
                        .settings-btn i {
                            margin-right: 8px;
                            font-size: 16px;
                            color: #b44ccc;
                        }
                        
                        /* تعديل الاتجاه في حالة اللغة العربية */
                        html[dir="rtl"] .settings-btn {
                            text-align: right;
                            justify-content: flex-start;
                        }
                        
                        html[dir="rtl"] .settings-btn i {
                            margin-right: 0;
                            margin-left: 8px;
                        }
                    </style>
                    
                    <!-- سيتم نقل قسم الإحصائيات المصغرة إلى نهاية القائمة الجانبية -->
                        <style>
                            /* تعديل عرض خلفية اللغة المختارة */
                            #languageMenu a.active {
                                background-color: rgba(177, 76, 200, 0.5);
                                width: 100%;
                                box-sizing: border-box;
                                font-weight: bold;
                            }
                            
                            /* أنماط للغات غير المدعومة */
                            #languageMenu a.lang-disabled {
                                opacity: 0.7;
                                background: rgba(0, 0, 0, 0.15);
                                cursor: default;
                            }
                            
                            /* إضافة الأعلام للغات الفرنسية والإسبانية */
                            #languageMenu a[data-lang="fr"]::before {
                                content: '🇫🇷';
                            }
                            
                            #languageMenu a[data-lang="es"]::before {
                                content: '🇪🇸';
                            }
                            
                            /* حل بسيط: تثبيت أيقونة الساعة الرملية في مكان ثابت */
                            #languageMenu a.lang-disabled {
                                position: relative;
                            }
                            
                            #languageMenu a.lang-disabled::after {
                                content: '⏳';
                                position: absolute !important;
                                right: 40px !important;
                                top: 50% !important;
                                transform: translateY(-50%) !important;
                                color: rgba(255, 255, 255, 0.85) !important;
                                font-size: 1.1em !important;
                                text-shadow: 0 0 3px rgba(0, 0, 0, 0.5) !important;
                                pointer-events: none;
                            }
                            
                            /* إزالة جميع التأثيرات على أسماء اللغات ليظهروا بشكل طبيعي */
                            /* تأثير خلفية التدرج المتحركة للقائمة */
                            #languageMenu {
                                /* أسلوب متناسق للقائمة كاملة */
                                position: relative;
                                overflow: visible;
                            }
                            
                            #languageMenu::after {
                                content: '';
                                position: absolute;
                                top: -20px;
                                left: -20px;
                                right: -20px;
                                bottom: -20px;
                                width: auto;  /* تحديد تلقائي للعرض */
                                height: auto; /* تحديد تلقائي للارتفاع */
                                background: linear-gradient(
                                  217deg, 
                                  rgba(177, 76, 200, 0.08), 
                                  rgba(177, 76, 200, 0) 70%
                                ),
                                linear-gradient(
                                  127deg, 
                                  rgba(0, 230, 255, 0.09), 
                                  rgba(0, 230, 255, 0) 70%
                                ),
                                linear-gradient(
                                  336deg, 
                                  rgba(176, 38, 255, 0.08), 
                                  rgba(176, 38, 255, 0) 70%
                                );
                                z-index: -2;
                                border-radius: 25px;
                                transform-origin: center;
                                animation: gradientMove 8s ease infinite;
                                /* ضمان ثبات حجم الخلفية المتحركة عند تبديل اللغة */
                                transform: translateZ(0);
                                backface-visibility: hidden;
                                perspective: 1000px;
                                padding: 20px; /* إضافة تباعد داخلي */
                                box-sizing: border-box; /* ضمان احتساب التباعد ضمن الحجم */
                            }
                            /* تأثير توهج بالخلفية عند العرض */
                            #languageMenu::before {
                                content: '';
                                position: absolute;
                                top: -15px;
                                left: -15px;
                                right: -15px;
                                bottom: -15px;
                                background: radial-gradient(circle at center, rgba(177, 76, 200, 0.25), transparent 70%);
                                pointer-events: none;
                                z-index: -1;
                                border-radius: 20px;
                                animation: glowPulse 3s infinite alternate;
                            }
                        </style>
                    </div>
                </div>
            </div>
            
            <!-- مساحة فارغة أسفل القائمة للتمرير بسهولة مع أيقونة قلب -->
            <div class="sidebar-spacer" style="height: 120px; padding-bottom: 80px;">
                <!-- إحصائيات المستخدم المصغرة - منقولة بجانب القلب -->
                <div class="mini-stats">
                    <div class="mini-stat-item">
                        <span id="favorites-count">0</span>
                        <span data-i18n="favCount">مفضلة</span>
                    </div>
                    <div class="mini-stat-item">
                        <span id="likes-count">0</span>
                        <span data-i18n="likeCount">إعجاب</span>
                    </div>
                </div>
                
                <div class="heart-icon">
                    <i class="fas fa-heart"></i>
                </div>
            </div>
            <!-- عنصر إضافي لضمان التمرير حتى نهاية القائمة -->
            <div style="height: 50px;"></div>
            
            <style>
                .mini-stats {
                    display: flex;
                    justify-content: space-between;
                    width: 100%;
                    font-size: 10px;
                    padding: 0 15px;
                    margin-bottom: 15px;
                    position: absolute;
                    bottom: 60px;
                    left: 0;
                    right: 0;
                }
                
                .mini-stat-item {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    background: rgba(0, 0, 0, 0.2);
                    border-radius: 5px;
                    padding: 2px 10px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }
                
                .mini-stat-item span:first-child {
                    font-weight: bold;
                    font-size: 12px;
                    color: #b44ccc;
                }
                
                .mini-stat-item span:last-child {
                    font-size: 9px;
                    color: rgba(255, 255, 255, 0.7);
                }
            </style>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="main-content">
        <div class="gallery-container">
            <!-- حقل البحث مع زر تفعيل المرشحات -->
            <div class="search-container">
                <!-- زر ربط البحث مع المرشحات - منقول إلى اليسار -->
                <button class="filter-toggle-btn active" id="filterToggleBtn" title="ربط البحث مع المرشحات" data-i18n-title="linkSearchFilters">
                    <i class="fas fa-link"></i>
                    <span class="filter-status-text" data-i18n="searchLinked">مربوط</span>
                </button>
                
                <input type="text" class="search-input" id="searchInput" placeholder="ابحث عن اسم صورة..." data-i18n-placeholder="searchPlaceholder">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <!-- حاوية أزرار الفئات المثبتة -->
            <div class="filters-container">
                <div class="filters">
                    <button class="filter-btn active" data-category="all" data-i18n="allImages"><span class="category-icon"><i class="fas fa-th-large" style="font-size: 0.9em;"></i></span> <span class="category-text">جميع الصور</span></button>
                    <button class="filter-btn" data-category="animals" data-i18n="animals"><span class="category-icon">🦁</span> <span class="category-text">حيوانات</span></button>
                    <button class="filter-btn" data-category="anime" data-i18n="anime"><span class="category-icon">&#10022;</span> <span class="category-text">أنمي</span></button>
                    <button class="filter-btn" data-category="creativity" data-i18n="creativity"><span class="category-icon">🎨</span> <span class="category-text">إبداع</span></button>
                    <button class="filter-btn" data-category="technology" data-i18n="technology"><span class="category-icon">💻</span> <span class="category-text">تكنولوجيا</span></button>
                    <button class="filter-btn" data-category="world" data-i18n="world"><span class="category-icon">🌍</span> <span class="category-text">عالم</span></button>
                    <button class="filter-btn" data-category="space" data-i18n="space"><span class="category-icon">🚀</span> <span class="category-text">فضاء</span></button>
                    <button class="filter-btn" data-category="classic" data-i18n="classic"><span class="category-icon">🏛️</span> <span class="category-text">كلاسيكي</span></button>
                </div>
            </div>
            
            <div class="masonry-grid">
                <div class="grid-sizer"></div>
                <div class="gutter-sizer"></div>
                <!-- صور المعرض ستضاف هنا بواسطة JavaScript -->
            </div>
        </div>
    </div>
    
    <script>
        // وظائف إدارة القائمة
        function initMenuToggle() {
            const menuButton = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const body = document.body;
            
            // التحقق من وجود العناصر
            if (!menuButton || !sidebar) {
                console.error('عناصر القائمة غير موجودة!');
                return;
            }
            
            // إضافة مستمع لحدث النقر على زر القائمة
            menuButton.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                sidebar.classList.add('user-toggled');
                
                // تغيير أيقونة زر القائمة
                const icon = menuButton.querySelector('i');
                if (sidebar.classList.contains('active')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
                
                // حفظ حالة القائمة في localStorage
                localStorage.setItem('sidebarOpen', sidebar.classList.contains('active') ? 'true' : 'false');
            });
            
            // التحقق من حجم الشاشة وضبط القائمة
            function checkScreenSize() {
                if (window.innerWidth >= 1200) { // شاشات سطح المكتب
                    // إظهار القائمة بشكل دائم على الشاشات الكبيرة
                    sidebar.classList.add('active', 'desktop-mode');
                    body.classList.add('sidebar-expanded');
                    
                    // إخفاء زر القائمة على الشاشات الكبيرة
                    menuButton.style.display = 'none';
                } else { // شاشات الهواتف والأجهزة اللوحية
                    // إظهار زر القائمة على الشاشات الصغيرة
                    menuButton.style.display = 'flex';
                    
                    // استعادة حالة القائمة من localStorage
                    const isOpen = localStorage.getItem('sidebarOpen') === 'true';
                    
                    // إزالة وضع سطح المكتب
                    sidebar.classList.remove('desktop-mode');
                    body.classList.remove('sidebar-expanded');
                    
                    // ضبط حالة القائمة بناءً على إعدادات المستخدم
                    if (isOpen && sidebar.classList.contains('user-toggled')) {
                        sidebar.classList.add('active');
                    } else {
                        sidebar.classList.remove('active');
                    }
                }
                
                // تحديث أيقونة زر القائمة
                updateMenuIcon();
            }
            
            // وظيفة تحديث أيقونة زر القائمة
            function updateMenuIcon() {
                const icon = menuButton.querySelector('i');
                if (sidebar.classList.contains('active')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            }
            
            // تفعيل فحص حجم الشاشة عند تغيير الحجم
            window.addEventListener('resize', checkScreenSize);
            
            // تطبيق التحقق الأولي من حجم الشاشة
            checkScreenSize();
            
            // إضافة مستمع لنقرات الصفحة لإغلاق القائمة عند النقر خارجها (للشاشات الصغيرة)
            document.addEventListener('click', function(event) {
                if (window.innerWidth < 1200 && 
                    sidebar.classList.contains('active') && 
                    !sidebar.contains(event.target) && 
                    !menuButton.contains(event.target)) {
                    sidebar.classList.remove('active');
                    updateMenuIcon();
                }
            });
        }
        
        // وظيفة ربط البحث مع المرشحات - التعديل A
        function initFilterToggle() {
            const filterToggleBtn = document.getElementById('filterToggleBtn');
            const searchInput = document.getElementById('searchInput');
            const filterStatusText = filterToggleBtn.querySelector('.filter-status-text');
            
            if (!filterToggleBtn || !searchInput) {
                console.error('عناصر زر ربط البحث غير موجودة!');
                return;
            }
            
            // حالة الربط (مربوط بشكل افتراضي)
            let searchLinked = true;
            
            // حفظ واستعادة حالة الربط من localStorage
            const savedState = localStorage.getItem('searchLinked');
            if (savedState !== null) {
                searchLinked = savedState === 'true';
            }
            
            // تطبيق الحالة الأولية
            updateLinkState();
            
            // إضافة مستمع لحدث النقر
            filterToggleBtn.addEventListener('click', function() {
                searchLinked = !searchLinked;
                updateLinkState();
                
                // حفظ الحالة الجديدة
                localStorage.setItem('searchLinked', searchLinked.toString());
                
                console.log('تم تغيير حالة ربط البحث إلى:', searchLinked ? 'مربوط' : 'منفصل');
                
                // إعادة تطبيق البحث إذا كان هناك نص في شريط البحث
                if (searchInput.value.trim()) {
                    const searchEvent = new Event('input');
                    searchInput.dispatchEvent(searchEvent);
                }
            });
            
            // وظيفة تحديث حالة الربط
            function updateLinkState() {
                const currentLang = document.documentElement.getAttribute('dir') === 'rtl' ? 'ar' : 'en';
                const searchContainer = document.querySelector('.search-container');
                
                if (searchLinked) {
                    filterToggleBtn.classList.remove('inactive');
                    filterToggleBtn.classList.add('active');
                    searchContainer.classList.remove('unlinked');
                    
                    // نص باللغة المناسبة
                    filterStatusText.textContent = currentLang === 'ar' ? 'مربوط' : 'Linked';
                    filterToggleBtn.title = currentLang === 'ar' ? 'فصل البحث عن المرشحات' : 'Unlink Search from Filters';
                } else {
                    filterToggleBtn.classList.remove('active');
                    filterToggleBtn.classList.add('inactive');
                    searchContainer.classList.add('unlinked');
                    
                    // نص باللغة المناسبة
                    filterStatusText.textContent = currentLang === 'ar' ? 'منفصل' : 'Separate';
                    filterToggleBtn.title = currentLang === 'ar' ? 'ربط البحث مع المرشحات' : 'Link Search with Filters';
                }
            }
            
            // إرجاع حالة الربط للاستخدام في وظائف أخرى
            window.isSearchLinked = function() {
                return searchLinked;
            };
        }
        
        // وظيفة تصفية المعرض حسب الأبعاد
        function filterByDimension(dimension) {
            console.log('تصفية حسب الأبعاد:', dimension);
            
            // التحقق من حالة ربط البحث مع المرشحات
            const isLinked = window.isSearchLinked ? window.isSearchLinked() : true;
            const hasSearchTerm = window.searchFilter && window.searchFilter.trim();
            
            // تحديث البعد في المتغير العام
            window.currentDimensionFilter = dimension;
            
            // تحديث حالة الأزرار
            document.querySelectorAll('.dimension-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetBtn = document.querySelector(`.dimension-btn[data-dimension="${dimension}"]`);
            if (targetBtn) targetBtn.classList.add('active');
            
            // إذا كان البحث منفصل عن المرشحات ويوجد نص بحث
            if (!isLinked && hasSearchTerm) {
                console.log('البحث منفصل عن المرشحات - تطبيق البحث مع البعد الجديد');
                
                // إعادة تطبيق البحث مع البعد الجديد (حتى في الحالة المنفصلة)
                searchGallery(window.searchFilter);
                return;
            }
            
            // إذا كان البحث مربوط مع المرشحات ويوجد نص بحث
            if (isLinked && hasSearchTerm) {
                console.log('البحث مربوط مع المرشحات - تطبيق البحث مع البعد الجديد');
                // إعادة تطبيق البحث مع البعد الجديد
                searchGallery(window.searchFilter);
                return;
            }
            
            // إذا لم يكن هناك بحث نشط، طبق فلتر الأبعاد فقط
            applyFilters();
            refreshMasonry();
            
            // تطبيق الفلتر مرة أخرى بعد فترة قصيرة للشاشات الصغيرة
            setTimeout(() => {
                applyFilters();
                refreshMasonry();
            }, 100);
        }
        
        // وظيفة تطبيق فلتر الأبعاد فقط (للحالة المنفصلة)
        function applyDimensionFilterOnly(dimension) {
            if (!window.hiddenItems) {
                window.hiddenItems = new Set();
            }
            
            const gridItems = document.querySelectorAll('.grid-item');
            
            gridItems.forEach(item => {
                const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                
                if (!item.getAttribute('data-id')) {
                    item.setAttribute('data-id', itemId);
                }
                
                let show = true;
                
                // تطبيق فلتر الأبعاد فقط
                if (dimension !== 'all') {
                    const itemDimension = item.getAttribute('data-dimension');
                    
                    if (itemDimension && itemDimension !== dimension) {
                        show = false;
                    } else if (!itemDimension) {
                        // حساب البعد إذا لم يكن محدد
                        const image = item.querySelector('img.gallery-image');
                        if (image && image.complete && image.naturalWidth > 0) {
                            const calculatedDimension = getImageDimensionType(image);
                            item.setAttribute('data-dimension', calculatedDimension);
                            
                            if (calculatedDimension !== dimension) {
                                show = false;
                            }
                        }
                    }
                }
                
                // تحديث حالة العنصر
                if (!show) {
                    window.hiddenItems.add(itemId);
                } else {
                    window.hiddenItems.delete(itemId);
                }
                
                applyItemVisibility(item, show);
            });
        }
        
        // وظيفة تصفية المعرض حسب الفئة
        function filterByCategory(category) {
            console.log('تصفية حسب الفئة:', category);
            
            // التحقق من حالة ربط البحث مع المرشحات
            const isLinked = window.isSearchLinked ? window.isSearchLinked() : true;
            const hasSearchTerm = window.searchFilter && window.searchFilter.trim();
            
            // تحديث الفئة في المتغير العام
            window.currentCategoryFilter = category;
            
            // تحديث حالة الأزرار
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetBtn = document.querySelector(`.filter-btn[data-category="${category}"]`);
            if (targetBtn) targetBtn.classList.add('active');
            
            // إذا كان البحث منفصل عن المرشحات ويوجد نص بحث
            if (!isLinked && hasSearchTerm) {
                console.log('البحث منفصل عن المرشحات - تطبيق فلتر الفئة مع الحفاظ على البحث');
                
                // تطبيق فلتر الفئة مع الحفاظ على البحث النشط
                applyCategoryWithActiveSearch(category);
                refreshMasonry();
                return;
            }
            
            // إذا كان البحث مربوط مع المرشحات ويوجد نص بحث
            if (isLinked && hasSearchTerm) {
                console.log('البحث مربوط مع المرشحات - تطبيق البحث مع الفئة الجديدة');
                // إعادة تطبيق البحث مع الفئة الجديدة
                searchGallery(window.searchFilter);
                return;
            }
            
            // إذا لم يكن هناك بحث نشط، طبق فلتر الفئة فقط
            applyFilters();
            refreshMasonry();
            
            // تطبيق الفلتر مرة أخرى بعد فترة قصيرة للشاشات الصغيرة
            setTimeout(() => {
                applyFilters();
                refreshMasonry();
            }, 100);
        }
        
        // وظيفة تطبيق فلتر الفئة مع الحفاظ على البحث نشطاً (للحالة المنفصلة)
        function applyCategoryWithActiveSearch(category) {
            if (!window.hiddenItems) {
                window.hiddenItems = new Set();
            }
            
            const gridItems = document.querySelectorAll('.grid-item');
            const hasSearchTerm = window.searchFilter && window.searchFilter.trim();
            
            gridItems.forEach(item => {
                const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                
                if (!item.getAttribute('data-id')) {
                    item.setAttribute('data-id', itemId);
                }
                
                let show = true;
                
                // أولاً: فحص البحث إذا كان نشطاً (له الأولوية في الحالة المنفصلة)
                if (hasSearchTerm) {
                    const title = item.getAttribute('data-title')?.toLowerCase() || '';
                    const itemCategory = item.getAttribute('data-category')?.toLowerCase() || '';
                    const tags = item.getAttribute('data-tags')?.toLowerCase() || '';
                    
                    // البحث في عنوان الصورة
                    const titleElement = item.querySelector('.image-title-badge');
                    const titleText = titleElement ? titleElement.textContent.toLowerCase() : '';
                    
                    // البحث في فئة الصورة
                    const categoryElement = item.querySelector('.category-badge');
                    const categoryText = categoryElement ? categoryElement.textContent.toLowerCase() : '';
                    
                    // جمع كل النصوص للبحث فيها
                    const searchableText = `${title} ${itemCategory} ${tags} ${titleText} ${categoryText}`;
                    
                    const match = searchableText.includes(window.searchFilter.toLowerCase().trim());
                    if (!match) {
                        show = false;
                    }
                }
                
                // ثانياً: فحص مرشح الأبعاد (يبقى نشطاً دائماً)
                if (window.currentDimensionFilter && window.currentDimensionFilter !== 'all' && show) {
                    const itemDimension = item.getAttribute('data-dimension') || '';
                    if (itemDimension && itemDimension !== window.currentDimensionFilter) {
                        show = false;
                    }
                }
                
                // ثالثاً: فحص فلتر الفئة (فقط إذا لم يكن هناك بحث نشط)
                if (!hasSearchTerm && category !== 'all' && show) {
                    const itemCategory = item.getAttribute('data-category');
                    if (itemCategory !== category) {
                        show = false;
                    }
                }
                
                // تحديث حالة العنصر
                if (!show) {
                    window.hiddenItems.add(itemId);
                } else {
                    window.hiddenItems.delete(itemId);
                }
                
                applyItemVisibility(item, show);
            });
        }
        
        // وظيفة تطبيق جميع الفلاتر
        function applyFilters() {
            // استخدام المتغيرات العمومية لحفظ حالة الفلتر
            const category = window.currentCategoryFilter || 'all';
            const dimension = window.currentDimensionFilter || 'all';
            
            // إنشاء مجموعة لتخزين معرفات العناصر المخفية إذا لم تكن موجودة
            if (!window.hiddenItems) {
                window.hiddenItems = new Set();
            }
            
            // تجنب طباعة رسائل التصفية في وحدة التحكم
            
            const gridItems = document.querySelectorAll('.grid-item');
            
            gridItems.forEach(item => {
                const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                
                // التأكد من أن كل عنصر له معرف
                if (!item.getAttribute('data-id')) {
                    item.setAttribute('data-id', itemId);
                }
                
                let show = true;
                
                // تطبيق فلتر الفئة
                if (category !== 'all') {
                    const itemCategory = item.getAttribute('data-category');
                    if (itemCategory !== category) {
                        show = false;
                    }
                }
                
                // تطبيق فلتر الأبعاد
                if (dimension !== 'all' && show) {
                    // أولا، نحاول استخدام السمة data-dimension المحددة مسبقا والمحسوبة بواسطة الدالة getImageDimensionType
                    const itemDimension = item.getAttribute('data-dimension');
                    
                    if (itemDimension && itemDimension !== dimension) {
                        // إذا كان للعنصر خاصية dimension ولا تتطابق مع الفلتر
                        show = false;
                    } else if (!itemDimension) {
                        // إذا لم تكن هناك سمة dimension بعد، نقوم بحسابها وتخزينها
                        const image = item.querySelector('img.gallery-image');
                        if (image && image.complete && image.naturalWidth > 0) {
                            // حساب البعد باستخدام الدالة الموحدة
                            const calculatedDimension = getImageDimensionType(image);
                            
                            // تخزين البعد المحسوب في السمة لاستخدامه لاحقاً
                            item.setAttribute('data-dimension', calculatedDimension);
                            
                            // التحقق مما إذا كان البعد المحسوب يتطابق مع الفلتر
                            if (calculatedDimension !== dimension) {
                                show = false;
                            }
                        } else {
                            // صورة غير محملة بعد، نعتبرها تتطابق مع الفلتر مؤقتاً
                            console.log('صورة غير محملة بعد، سنعتبرها مطابقة للفلتر:', dimension);
                            
                            // إضافة مستمع لتحميل الصورة لتطبيق الفلتر بعد التحميل
                            if (image) {
                                image.onload = function() {
                                    // حساب البعد بعد تحميل الصورة
                                    const loadedDimension = getImageDimensionType(this);
                                    item.setAttribute('data-dimension', loadedDimension);
                                    
                                    // إعادة تطبيق الفلاتر بعد التحميل إذا كان الفلتر لا يزال نشطاً
                                    if (window.currentDimensionFilter === dimension) {
                                        applyFilters();
                                    }
                                };
                            }
                        }
                    }
                }
                
                // تخزين حالة العنصر
                if (!show) {
                    window.hiddenItems.add(itemId);
                } else {
                    window.hiddenItems.delete(itemId);
                }
                
                // تطبيق العرض مع مراعاة طريقة العرض
                applyItemVisibility(item, show);
            });
            
            // تخزين حالة الفلتر في localStorage
            try {
                localStorage.setItem('currentCategoryFilter', category);
                localStorage.setItem('currentDimensionFilter', dimension);
            } catch (e) {
                console.error('خطأ في حفظ حالة الفلتر:', e);
            }
        }
        
        // وظيفة مساعدة لضبط رؤية العنصر بناءً على فلتر العرض
        function applyItemVisibility(item, show) {
            if (show) {
                // إظهار العنصر - موحد لجميع الأوضاع
                // نستخدم نفس الأسلوب الذي يعمل في الزر الأول
                item.style.display = '';
                item.style.visibility = 'visible';
                item.style.height = '';
                item.style.margin = '';
                item.style.padding = '';
                item.style.overflow = '';
            } else {
                // إخفاء العنصر - موحد لجميع الأوضاع
                // نستخدم نفس الأسلوب الذي يعمل في الزر الأول
                item.style.display = 'none';
                item.style.visibility = 'hidden';
            }
        }
        
        // وظيفة تحديث Masonry بعد تطبيق الفلاتر

        
        /**
         * تحديد أبعاد الصورة مسبقاً من بيانات الميتا المتوفرة
         * @param {Object} imageData - بيانات الصورة
         * @returns {Object} أبعاد الصورة (العرض والارتفاع) بناءً على نسبة الأبعاد المعروفة
         */
        function getPresetDimensions(imageData) {
            // تحديد القيم الافتراضية
            let width = 300; // عرض افتراضي معقول
            let height = 300; // ارتفاع افتراضي معقول
            
            // تحديد الأبعاد بناءً على الاتجاه (إذا كان معروفاً)
            if (imageData.dimension === 'portrait' || imageData.orientation === 'portrait') {
                // صورة طولية: أطول من عرضها
                width = 300;
                height = 450; // نسبة 2:3 تقريباً
            } else if (imageData.dimension === 'landscape' || imageData.orientation === 'landscape') {
                // صورة عرضية: أعرض من طولها
                width = 450;
                height = 300; // نسبة 3:2 تقريباً
            } else if (imageData.dimension === 'square' || imageData.orientation === 'square') {
                // صورة مربعة
                width = 300;
                height = 300;
            }
            
            // يمكن إضافة المزيد من المنطق هنا للحصول على أبعاد أكثر دقة إذا كانت متوفرة
            
            return { width, height };
        }

        function refreshMasonry() {
            const grid = document.querySelector('.masonry-grid');
            if (!grid) return;
            
            // تحديد أنواع الشاشات
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 480;
            const isWideView = document.body.classList.contains('wide-view');
            const isWideMobileView = document.body.classList.contains('wide-mobile-view');
            const needsCustomLayout = isMobile && (isWideView || isWideMobileView);
            
            // إلغاء أي مثيلات سابقة لـ Masonry قبل إعادة التطبيق
            const masonry = Masonry.data(grid);
            if (masonry) {
                masonry.destroy();
                // تخزين المرجع للاستخدام المستقبلي
                window.msnry = null;
            }
            
            // تنظيف أي أنماط CSS موروثة
            grid.style.height = '';
            
            if (needsCustomLayout) {
                // تطبيق تخطيط مخصص للشاشات الصغيرة في الوضع العريض
                // حالة جديدة للشاشات الصغيرة: صورتان في صف واحد (بدون أعمدة متعددة)
                
                // تطبيق نمط columns للحاوية
                grid.style.display = 'block';
                grid.style.columnCount = '2';
                grid.style.columnGap = '6px';
                
                // ضبط العناصر لنظام العمودين
                const items = document.querySelectorAll('.grid-item');
                items.forEach(item => {
                    // الحصول على معرف العنصر
                    const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                    
                    // تأكد من أن العنصر له معرف
                    if (!item.getAttribute('data-id')) {
                        item.setAttribute('data-id', itemId);
                    }
                    
                    // تحقق ما إذا كان العنصر مخفيًا حسب الفلاتر المطبقة
                    const isHidden = window.hiddenItems && window.hiddenItems.has(itemId);
                    
                    // تطبيق الأنماط الأساسية على جميع العناصر
                    item.style.width = '100%';
                    item.style.marginBottom = '6px';
                    item.style.breakInside = 'avoid';
                    
                    // تطبيق حالة الظهور/الإخفاء بالضبط كما في الوضع الافتراضي
                    if (isHidden) {
                        // نستخدم display:none تمامًا مثل الوضع الافتراضي
                        item.style.display = 'none';
                        item.style.visibility = 'hidden';
                    } else {
                        // إظهار العنصر
                        item.style.display = 'inline-block';
                        item.style.visibility = 'visible';
                        item.style.height = '';
                        item.style.margin = '';
                        item.style.padding = '';
                        item.style.overflow = '';
                    }
                });
                
                // إخفاء عنصر التحجيم
                const sizer = document.querySelector('.grid-sizer');
                if (sizer) sizer.style.display = 'none';
                
                return; // لا حاجة لتهيئة Masonry
            } else {
                // استخدم Masonry للشاشات الأكبر أو عندما لا يكون العرض العريض
                setTimeout(() => {
                    new Masonry(grid, {
                        itemSelector: '.grid-item',
                        columnWidth: '.grid-sizer',
                        gutter: '.gutter-sizer',
                        percentPosition: true
                    });
                }, 200);
            }
        }
        
        /**
         * التعامل مع النقر على زر الوضع العريض
         * يتحقق من حجم الشاشة ويعرض رسالة تنبيه في الشاشات الصغيرة
         */
        function handleWideViewClick() {
            const screenWidth = window.innerWidth;
            
            // التحقق من الشاشات الصغيرة (768px أو أقل)
            if (screenWidth <= 768) {
                // عرض رسالة التنبيه المحسنة
                showCustomAlert();
                return;
            }
            
            // إذا لم تكن شاشة صغيرة، تفعيل الوضع العريض
            setGridColumns('wide');
        }

        /**
         * عرض رسالة تنبيه مخصصة بتصميم جميل
         */
        function showCustomAlert() {
            // الحصول على اللغة الحالية
            const currentLang = localStorage.getItem('language') || 'ar';
            
            // تحديد النصوص حسب اللغة
            const texts = currentLang === 'en' ? {
                title: 'Wide View Not Available',
                message: 'Wide view mode is not available on small screens. Please switch to a larger screen to use this feature.',
                button: 'Got it'
            } : {
                title: 'الوضع العريض غير متاح',
                message: 'وضع العرض العريض غير متاح في الشاشات الصغيرة. يمكنك الانتقال إلى شاشة أكبر لاستخدام هذه الميزة.',
                button: 'فهمت'
            };
            
            // إنشاء عنصر الرسالة
            const alertOverlay = document.createElement('div');
            alertOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;
            
            // إنشاء مربع الرسالة
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                background: linear-gradient(135deg, rgba(13, 0, 13, 0.95), rgba(25, 10, 25, 0.95));
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 20px;
                padding: 30px;
                max-width: 350px;
                margin: 20px;
                text-align: center;
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
                transform: scale(0.8);
                animation: popIn 0.3s ease-out forwards;
            `;
            
            // إضافة الأنيميشن
            const style = document.createElement('style');
            style.textContent = `
                @keyframes popIn {
                    to {
                        transform: scale(1);
                    }
                }
            `;
            document.head.appendChild(style);
            
            // إنشاء أيقونة التنبيه
            const icon = document.createElement('div');
            icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            icon.style.cssText = `
                font-size: 48px;
                color: #ff6b6b;
                margin-bottom: 20px;
            `;
            
            // إنشاء العنوان
            const title = document.createElement('h3');
            title.textContent = texts.title;
            title.style.cssText = `
                color: white;
                margin: 0 0 15px 0;
                font-size: 20px;
                font-weight: bold;
            `;
            
            // إنشاء الرسالة
            const message = document.createElement('p');
            message.textContent = texts.message;
            message.style.cssText = `
                color: rgba(255, 255, 255, 0.9);
                margin: 0 0 25px 0;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            // إنشاء الزر
            const button = document.createElement('button');
            button.textContent = texts.button;
            button.style.cssText = `
                background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
                color: white;
                border: none;
                padding: 12px 30px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            `;
            
            // تأثير الزر عند التمرير
            button.addEventListener('mouseenter', () => {
                button.style.transform = 'translateY(-2px)';
                button.style.boxShadow = '0 6px 20px rgba(255, 107, 107, 0.4)';
            });
            
            button.addEventListener('mouseleave', () => {
                button.style.transform = 'translateY(0)';
                button.style.boxShadow = '0 4px 15px rgba(255, 107, 107, 0.3)';
            });
            
            // إغلاق الرسالة عند النقر على الزر
            button.addEventListener('click', () => {
                alertOverlay.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => {
                    document.body.removeChild(alertOverlay);
                }, 300);
            });
            
            // إضافة أنيميشن الإغلاق
            style.textContent += `
                @keyframes fadeOut {
                    to {
                        opacity: 0;
                        transform: scale(0.9);
                    }
                }
            `;
            
            // تجميع العناصر
            alertBox.appendChild(icon);
            alertBox.appendChild(title);
            alertBox.appendChild(message);
            alertBox.appendChild(button);
            alertOverlay.appendChild(alertBox);
            
            // إضافة الرسالة للصفحة
            document.body.appendChild(alertOverlay);
            
            // إغلاق الرسالة عند النقر خارج المربع
            alertOverlay.addEventListener('click', (e) => {
                if (e.target === alertOverlay) {
                    button.click();
                }
            });
        }

        /**
         * تغيير عدد الأعمدة في المعرض
         * وظيفة مبسطة وواضحة للتحكم في طريقة عرض الصور
         * @param {string} mode - وضع العرض ('default' أو 'wide')
         */
        function setGridColumns(mode) {
            // تغيير طريقة العرض
            
            // حفظ وضع العرض في التخزين المحلي
            localStorage.setItem('viewMode', mode);
            
            // تحديث حالة أزرار التبديل
            document.getElementById('defaultViewBtn').classList.toggle('active', mode === 'default');
            document.getElementById('wideViewBtn').classList.toggle('active', mode === 'wide');
            
            // تطبيق فئات CSS للجسم
            document.body.classList.toggle('wide-view', mode === 'wide');
            document.body.classList.toggle('default-view', mode === 'default');
            
            // الحصول على عناصر المعرض
            const gridItems = document.querySelectorAll('.grid-item');
            const gridSizer = document.querySelector('.grid-sizer');
            const masonryGrid = document.querySelector('.masonry-grid');
            
            // حفظ حالة التصفية الحالية
            const currentCategory = window.currentCategoryFilter;
            const currentDimension = window.currentDimensionFilter;
            
            // تحديد حجم الشاشة
            const screenWidth = window.innerWidth;
            
            // تطبيق التخطيط المناسب بناءً على حجم الشاشة
            if (screenWidth <= 480) {
                // الشاشات الصغيرة جداً (الهواتف المحمولة الصغيرة)
                applyMobileLayout(mode, gridItems, gridSizer, masonryGrid);
            } else if (screenWidth > 480 && screenWidth <= 768) {
                // الشاشات الصغيرة (الهواتف المحمولة الكبيرة)
                applyMobileLayout(mode, gridItems, gridSizer, masonryGrid);
            } else if (screenWidth > 768 && screenWidth <= 1199) {
                // الشاشات المتوسطة (الأجهزة اللوحية)
                applyTabletLayout(mode, gridItems, gridSizer, masonryGrid);
            } else {
                // الشاشات الكبيرة (أجهزة الكمبيوتر - 1200px فما فوق)
                applyDesktopLayout(mode, gridItems, gridSizer, masonryGrid);
            }
            
            // إعادة تطبيق التصفية الحالية إذا كانت موجودة
            if (currentCategory) {
                window.currentCategoryFilter = currentCategory;
                // تحديث حالة أزرار الفئات
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const categoryBtn = document.querySelector(`.filter-btn[data-category="${currentCategory}"]`);
                if (categoryBtn) {
                    categoryBtn.classList.add('active');
                }
            }
            
            if (currentDimension) {
                window.currentDimensionFilter = currentDimension;
                // تحديث حالة أزرار الأبعاد
                document.querySelectorAll('.dimension-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const dimensionBtn = document.querySelector(`.dimension-btn[data-dimension="${currentDimension}"]`);
                if (dimensionBtn) {
                    dimensionBtn.classList.add('active');
                }
            }
            
            // تطبيق الفلاتر النشطة
            applyFilters();
            
            // ثم تطبيق Masonry بعد تغيير التخطيط
            refreshMasonry();
            
            // تحديث التخطيط مرة أخرى بعد تأخير قصير للتأكد من تطبيق التغييرات
            setTimeout(() => {
                // تطبيق الفلاتر مرة أخرى لضمان العرض الصحيح
                applyFilters();
                refreshMasonry();
            }, 200);
        }
        
        /**
         * تطبيق تخطيط الشبكة للشاشات الكبيرة (الكمبيوتر)
         * @param {string} mode - وضع العرض
         * @param {NodeList} gridItems - عناصر الشبكة
         * @param {Element} gridSizer - عنصر تحجيم الشبكة
         * @param {Element} masonryGrid - عنصر شبكة ماسونري
         */
        function applyDesktopLayout(mode, gridItems, gridSizer, masonryGrid) {
            if (mode === 'default') {
                // الوضع الافتراضي: 3 صور في كل صف
                document.documentElement.style.setProperty('--grid-columns', '3');
                
                if (gridSizer) gridSizer.style.width = 'calc(33.333% - 10px)';
                gridItems.forEach(item => {
                    // الحصول على معرف العنصر
                    const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                    
                    // تأكد من أن العنصر له معرف
                    if (!item.getAttribute('data-id')) {
                        item.setAttribute('data-id', itemId);
                    }
                    
                    // تحقق ما إذا كان العنصر مخفيًا حسب الفلاتر المطبقة
                    const isHidden = window.hiddenItems && window.hiddenItems.has(itemId);
                    
                    item.style.width = 'calc(33.333% - 10px)';
                    item.style.float = '';
                    item.style.marginRight = '';
                    item.style.breakInside = '';
                    
                    // تطبيق حالة الظهور/الإخفاء
                    if (isHidden) {
                        item.style.display = 'none';
                        item.style.visibility = 'hidden';
                    } else {
                        item.style.display = '';
                        item.style.visibility = 'visible';
                        item.style.height = '';
                        item.style.margin = '';
                        item.style.padding = '';
                        item.style.overflow = '';
                    }
                });
                
                resetGridLayout(masonryGrid);
                
            } else if (mode === 'wide') {
                // الوضع العريض: 4 صور في كل صف
                document.documentElement.style.setProperty('--grid-columns', '4');
                
                if (gridSizer) gridSizer.style.width = 'calc(25% - 11.25px)';
                gridItems.forEach(item => {
                    // الحصول على معرف العنصر
                    const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                    
                    // تأكد من أن العنصر له معرف
                    if (!item.getAttribute('data-id')) {
                        item.setAttribute('data-id', itemId);
                    }
                    
                    // تحقق ما إذا كان العنصر مخفيًا حسب الفلاتر المطبقة
                    const isHidden = window.hiddenItems && window.hiddenItems.has(itemId);
                    
                    item.style.width = 'calc(25% - 11.25px)';
                    item.style.float = '';
                    item.style.marginRight = '';
                    item.style.breakInside = '';
                    
                    // تطبيق حالة الظهور/الإخفاء
                    if (isHidden) {
                        item.style.display = 'none';
                        item.style.visibility = 'hidden';
                    } else {
                        item.style.display = '';
                        item.style.visibility = 'visible';
                        item.style.height = '';
                        item.style.margin = '';
                        item.style.padding = '';
                        item.style.overflow = '';
                    }
                });
                
                resetGridLayout(masonryGrid);
            }
        }
        
        /**
         * تطبيق تخطيط الشبكة للشاشات المتوسطة (الأجهزة اللوحية)
         * @param {string} mode - وضع العرض
         * @param {NodeList} gridItems - عناصر الشبكة
         * @param {Element} gridSizer - عنصر تحجيم الشبكة
         * @param {Element} masonryGrid - عنصر شبكة ماسونري
         */
        function applyTabletLayout(mode, gridItems, gridSizer, masonryGrid) {
            if (mode === 'default') {
                // الوضع الافتراضي: 2 صور في كل صف باستخدام Masonry
                document.documentElement.style.setProperty('--medium-columns', '2');
                
                if (gridSizer) gridSizer.style.width = 'calc(50% - 10px)';
                gridItems.forEach(item => {
                    // الحصول على معرف العنصر
                    const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                    
                    // تأكد من أن العنصر له معرف
                    if (!item.getAttribute('data-id')) {
                        item.setAttribute('data-id', itemId);
                    }
                    
                    // تحقق ما إذا كان العنصر مخفيًا حسب الفلاتر المطبقة
                    const isHidden = window.hiddenItems && window.hiddenItems.has(itemId);
                    
                    // ضبط خصائص العرض الأساسية للعمل مع Masonry
                    item.style.width = 'calc(50% - 10px)';
                    item.style.float = '';  // إزالة float للعمل مع Masonry
                    item.style.marginRight = '';
                    item.style.marginBottom = '15px';
                    item.style.breakInside = '';
                    
                    // تطبيق حالة الظهور/الإخفاء
                    if (isHidden) {
                        item.style.display = 'none';
                        item.style.visibility = 'hidden';
                    } else {
                        item.style.display = 'block';  // استخدام 'block' بدلاً من '' لضمان الظهور الصحيح
                        item.style.visibility = 'visible';
                        item.style.height = '';
                        item.style.padding = '';
                        item.style.overflow = '';
                    }
                });
                
                // هنا نقوم بإزالة Masonry ثم تهيئة layout جديد
                if (masonryGrid) {
                    masonryGrid.style.position = 'relative';
                    masonryGrid.style.height = 'auto';
                }
                
            } else if (mode === 'wide') {
                // الوضع العريض: 3 صور في كل صف باستخدام Masonry
                document.documentElement.style.setProperty('--medium-columns', '3');
                
                if (gridSizer) gridSizer.style.width = 'calc(33.33% - 10px)';
                gridItems.forEach(item => {
                    // الحصول على معرف العنصر
                    const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                    
                    // تأكد من أن العنصر له معرف
                    if (!item.getAttribute('data-id')) {
                        item.setAttribute('data-id', itemId);
                    }
                    
                    // تحقق ما إذا كان العنصر مخفيًا حسب الفلاتر المطبقة
                    const isHidden = window.hiddenItems && window.hiddenItems.has(itemId);
                    
                    // ضبط خصائص العرض الأساسية للعمل مع Masonry
                    item.style.width = 'calc(33.33% - 10px)';
                    item.style.float = '';  // إزالة float للعمل مع Masonry
                    item.style.marginRight = '';
                    item.style.marginBottom = '15px';
                    item.style.breakInside = '';
                    
                    // تطبيق حالة الظهور/الإخفاء
                    if (isHidden) {
                        item.style.display = 'none';
                        item.style.visibility = 'hidden';
                    } else {
                        item.style.display = '';
                        item.style.visibility = 'visible';
                        item.style.height = '';
                        item.style.margin = '';
                        item.style.padding = '';
                        item.style.overflow = '';
                    }
                });
                
                resetGridLayout(masonryGrid);
            }
        }
        
        /**
         * تطبيق تخطيط الشبكة للشاشات الصغيرة (الهواتف المحمولة)
         * @param {string} mode - وضع العرض
         * @param {NodeList} gridItems - عناصر الشبكة
         * @param {Element} gridSizer - عنصر تحجيم الشبكة
         * @param {Element} masonryGrid - عنصر شبكة ماسونري
         */
        function applyMobileLayout(mode, gridItems, gridSizer, masonryGrid) {
            if (mode === 'default') {
                // الوضع الافتراضي: صورة واحدة في كل صف
                document.documentElement.style.setProperty('--small-columns', '1');
                
                // إزالة أي أنماط من العرض السابق
                document.body.classList.remove('wide-mobile-view');
                document.body.classList.add('default-mobile-view');
                
                // إخفاء إشعار حالة الفلتر إذا كان ظاهراً
                hideFilterStatusNotification();
                
                // تعيين خصائص العناصر
                if (gridSizer) gridSizer.style.width = '100%';
                gridItems.forEach(item => {
                    // الحصول على معرف العنصر
                    const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                    
                    // تأكد من أن العنصر له معرف
                    if (!item.getAttribute('data-id')) {
                        item.setAttribute('data-id', itemId);
                    }
                    
                    // تحقق ما إذا كان العنصر مخفيًا حسب الفلاتر المطبقة
                    const isHidden = window.hiddenItems && window.hiddenItems.has(itemId);
                    
                    // تطبيق الأنماط الجديدة مع الحفاظ على حالة العرض
                    item.style.width = '100%';
                    item.style.float = 'none';
                    item.style.marginRight = '0';
                    item.style.marginBottom = '15px';
                    
                    // إزالة شارة الأبعاد إذا كانت موجودة
                    const dimensionBadge = item.querySelector('.dimension-badge');
                    if (dimensionBadge) {
                        dimensionBadge.remove();
                    }
                    
                    // إعادة تطبيق حالة الإخفاء بناءً على حالة الفلتر
                    if (isHidden) {
                        item.style.display = 'none';
                        item.style.visibility = 'hidden';
                    } else {
                        item.style.display = 'block';
                        item.style.visibility = 'visible';
                        item.style.height = '';
                        item.style.margin = '15px 0';
                        item.style.overflow = '';
                    }
                });
                
                // إعادة تعيين خصائص شبكة Masonry
                if (masonryGrid) {
                    masonryGrid.style.display = 'block';
                    masonryGrid.style.columnCount = '1';
                    masonryGrid.style.columnGap = '0';
                    masonryGrid.classList.remove('wide-grid');
                }
                
                // حفظ وضع العرض الحالي في متغير عام
                window.currentViewMode = 'default';
                
            } else if (mode === 'wide') {
                // التعديل A: استخدام نفس كود الوضع العريض للشاشات الكبيرة مع تعديل حجم الصور فقط
                document.documentElement.style.setProperty('--small-columns', '2');
                
                // إضافة فئة خاصة لتسهيل التنسيق
                document.body.classList.remove('default-mobile-view');
                document.body.classList.add('wide-mobile-view');
                
                // تطبيق تخطيط مخصص للشاشات الصغيرة في الوضع العريض
                
                // تطبيق نظام Masonry للشاشات الصغيرة (بدلاً من نظام العمودين)
                if (masonryGrid) {
                    masonryGrid.style.display = '';
                    masonryGrid.style.columnCount = '';
                    masonryGrid.style.columnGap = '';
                    masonryGrid.style.width = '100%';
                    masonryGrid.classList.add('wide-grid');
                    
                    // إذا كان هناك مسافة بادئة للنافذة الجانبية، نضبط العرض
                    const sidebarOpen = document.body.classList.contains('sidebar-open');
                    if (sidebarOpen) {
                        masonryGrid.style.marginLeft = '0';
                    }
                }
                
                // تنسيق العناصر باستخدام نفس منطق الشاشات الكبيرة ولكن مع تعديل الحجم
                if (gridSizer) gridSizer.style.width = 'calc(50% - 5px)';
                
                gridItems.forEach(item => {
                    // الحصول على معرف العنصر
                    const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                    
                    // تأكد من أن العنصر له معرف
                    if (!item.getAttribute('data-id')) {
                        item.setAttribute('data-id', itemId);
                    }
                    
                    // تحقق ما إذا كان العنصر مخفيًا حسب الفلاتر المطبقة
                    const isHidden = window.hiddenItems && window.hiddenItems.has(itemId);
                    
                    // تطبيق الأنماط استنادًا إلى الشاشات الكبيرة مع ضبط الحجم وتقليل المسافة
                    item.style.width = 'calc(50% - 5px)';
                    item.style.float = 'left';
                    item.style.marginRight = '10px';
                    item.style.marginBottom = '10px';
                    item.style.breakInside = '';
                    
                    // تطبيق حالة الظهور/الإخفاء
                    if (isHidden) {
                        item.style.display = 'none';
                        item.style.visibility = 'hidden';
                    } else {
                        item.style.display = 'block';
                        item.style.visibility = 'visible';
                        item.style.height = '';
                        item.style.padding = '';
                        item.style.overflow = '';
                    }
                });
                
                // إضافة Masonry للشاشات الصغيرة في الوضع العريض
                if (!window.msnry && masonryGrid) {
                    setTimeout(() => {
                        window.msnry = new Masonry(masonryGrid, {
                            itemSelector: '.grid-item',
                            columnWidth: '.grid-sizer',
                            percentPosition: true,
                            transitionDuration: '0.3s'
                        });
                    }, 100);
                } else if (window.msnry) {
                    window.msnry.layout();
                }
                
                // حفظ وضع العرض الحالي في متغير عام
                window.currentViewMode = 'wide';
                
                // تأخير إضافي للشاشات الصغيرة
                setTimeout(() => {
                    refreshMasonry();
                }, 250);
            }
        }

        /**
         * وظيفة تغيير وضع العرض مع الحفاظ على البحث
         * @param {string} type - نوع وضع العرض ('default' أو 'wide')
         */
        function setGridColumnsWithSearch(type) {
            console.log('تغيير وضع العرض إلى:', type);
            
            // حفظ حالة البحث والمرشحات الحالية قبل التغيير
            const currentSearch = window.searchFilter;
            const currentCategory = window.currentCategoryFilter;
            const currentDimension = window.currentDimensionFilter;
            const hasSearchTerm = currentSearch && currentSearch.trim();
            const isLinked = window.isSearchLinked ? window.isSearchLinked() : true;
            
            console.log('حالة البحث المحفوظة:', {
                search: currentSearch,
                category: currentCategory,
                dimension: currentDimension,
                hasSearch: hasSearchTerm,
                isLinked: isLinked
            });
            
            // تطبيق تغيير وضع العرض
            if (type === 'wide') {
                // للعرض العريض، استخدم handleWideViewClick إذا كانت موجودة، وإلا استخدم setGridColumns
                if (typeof handleWideViewClick === 'function') {
                    handleWideViewClick();
                } else {
                    setGridColumns('wide');
                }
            } else {
                setGridColumns('default');
            }
            
            // إعادة تطبيق البحث والمرشحات إذا كانت موجودة
            if (hasSearchTerm) {
                console.log('إعادة تطبيق البحث بعد تغيير وضع العرض:', currentSearch);
                
                setTimeout(() => {
                    // استعادة حالة البحث والمرشحات
                    window.searchFilter = currentSearch;
                    window.currentCategoryFilter = currentCategory;
                    window.currentDimensionFilter = currentDimension;
                    
                    // تحديث قيمة شريط البحث
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = currentSearch;
                    }
                    
                    // تطبيق البحث حسب حالة زر الربط
                    if (isLinked) {
                        // البحث مربوط - تطبيق البحث مع المرشحات
                        console.log('البحث مربوط - تطبيق البحث مع المرشحات');
                        searchGallery(currentSearch);
                    } else {
                        // البحث منفصل - تطبيق البحث بمفرده
                        console.log('البحث منفصل - تطبيق البحث بمفرده');
                        searchGallery(currentSearch);
                    }
                    
                    // التأكد من تحديث حالة الأزرار
                    updateButtonStates();
                }, 200); // تأخير أطول للتأكد من اكتمال تغيير وضع العرض
            } else {
                console.log('لا يوجد بحث نشط - عرض كامل المعرض');
            }
        }
        
        /**
         * تحديث حالة أزرار المرشحات
         */
        function updateButtonStates() {
            // تحديث أزرار الفئات
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeCategoryBtn = document.querySelector(`.filter-btn[data-category="${window.currentCategoryFilter}"]`);
            if (activeCategoryBtn) activeCategoryBtn.classList.add('active');
            
            // تحديث أزرار الأبعاد
            document.querySelectorAll('.dimension-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeDimensionBtn = document.querySelector(`.dimension-btn[data-dimension="${window.currentDimensionFilter}"]`);
            if (activeDimensionBtn) activeDimensionBtn.classList.add('active');
        }
        

        
        /**
         * اكتشاف أبعاد الصورة بناءً على حجمها
         * @param {HTMLElement} element - عنصر الصورة
         * @returns {string} نوع البعد ('portrait', 'landscape', 'square')
         */
        function detectImageDimension(element) {
            const img = element.querySelector('img');
            if (!img) return 'square';
            
            // محاولة تحميل الصورة إذا لم تكن محملة بعد
            if (!img.complete) {
                img.onload = function() {
                    // إعادة تقييم الأبعاد بعد تحميل الصورة
                    const dimension = getImageDimensionType(img);
                    element.setAttribute('data-dimension', dimension);
                    
                    // تحديث الشارة إذا كانت موجودة
                    const badge = element.querySelector('.dimension-badge');
                    if (badge) {
                        updateDimensionBadge(badge, element);
                    }
                };
                return element.getAttribute('data-dimension') || 'square';
            }
            
            return getImageDimensionType(img);
        }
        
        /**
         * الحصول على نوع أبعاد الصورة (طولي، عرضي، مربع)
         * @param {HTMLImageElement} img - عنصر الصورة
         * @returns {string} نوع البعد ('portrait', 'landscape', 'square')
         */
        function getImageDimensionType(img) {
            const width = img.naturalWidth || img.width || 0;
            const height = img.naturalHeight || img.height || 0;
            
            if (width && height) {
                const ratio = width / height;
                
                if (ratio < 0.9) {
                    return 'portrait';  // طولي
                } else if (ratio > 1.1) {
                    return 'landscape'; // عرضي
                } else {
                    return 'square';   // مربع
                }
            }
            
            return 'square'; // افتراضي إذا لم نتمكن من الحصول على الأبعاد
        }
        
        /**
         * عرض إشعار بحالة الفلتر الحالية
         */
        function showFilterStatusNotification() {
            // إزالة الإشعار السابق إذا كان موجوداً
            hideFilterStatusNotification();
            
            // الحصول على الفئة والأبعاد الحالية
            const category = window.currentCategoryFilter || 'all';
            const dimension = window.currentDimensionFilter || 'all';
            
            // إنشاء نص الإشعار
            let categoryText = 'جميع الفئات';
            if (category !== 'all') {
                categoryText = document.querySelector(`.filter-btn[data-category="${category}"]`)?.textContent?.trim() || category;
            }
            
            let dimensionText = 'جميع الأبعاد';
            let dimensionIcon = '🔍';
            
            if (dimension === 'portrait') {
                dimensionText = 'طولي';
                dimensionIcon = '⬜';
            } else if (dimension === 'landscape') {
                dimensionText = 'عرضي';
                dimensionIcon = '⬛';
            } else if (dimension === 'square') {
                dimensionText = 'مربع';
                dimensionIcon = '◼️';
            }
            
            // إنشاء عنصر الإشعار
            const notification = document.createElement('div');
            notification.id = 'filter-status-notification';
            notification.innerHTML = `
                <div class="filter-status-content">
                    <div class="filter-status-item">
                        <span class="filter-status-icon">📁</span>
                        <span class="filter-status-text">${categoryText}</span>
                    </div>
                    <div class="filter-status-item">
                        <span class="filter-status-icon">${dimensionIcon}</span>
                        <span class="filter-status-text">${dimensionText}</span>
                    </div>
                </div>
                <button class="filter-status-close" onclick="hideFilterStatusNotification()">×</button>
            `;
            
            // تطبيق الأنماط
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(58, 16, 69, 0.9);
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 14px;
                max-width: 90%;
                width: auto;
                backdrop-filter: blur(5px);
                border: 1px solid rgba(177, 76, 200, 0.3);
            `;
            
            // تطبيق الأنماط للعناصر الداخلية
            const style = document.createElement('style');
            style.textContent = `
                .filter-status-content {
                    display: flex;
                    flex-direction: column;
                    gap: 5px;
                }
                .filter-status-item {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
                .filter-status-icon {
                    font-size: 16px;
                }
                .filter-status-text {
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                .filter-status-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 0 0 0 10px;
                    margin: 0;
                }
            `;
            
            document.head.appendChild(style);
            document.body.appendChild(notification);
            
            // إخفاء الإشعار بعد 5 ثوانٍ
            setTimeout(hideFilterStatusNotification, 5000);
        }
        
        /**
         * إخفاء إشعار حالة الفلتر
         */
        function hideFilterStatusNotification() {
            const notification = document.getElementById('filter-status-notification');
            if (notification) {
                notification.remove();
            }
        }
        
        // إتاحة دالة إخفاء الإشعار عالمياً
        window.hideFilterStatusNotification = hideFilterStatusNotification;
        
        /**
         * تحسين عرض الصور في الوضع العريض للشاشات الصغيرة
         * تعديل عرض الصور المربعة والأفقية لتأخذ عرض كامل واستغلال المساحة بشكل أفضل
         * @param {NodeList} gridItems - عناصر الشبكة
         */
        function optimizeImagesForWideViewInMobile(gridItems) {
            // تطبيق تخطيط مخصص للشاشات الصغيرة في الوضع العريض
            
            // إضافة CSS لمعالجة السمة data-fullwidth
            if (!document.getElementById('fullwidth-image-styles')) {
                const style = document.createElement('style');
                style.id = 'fullwidth-image-styles';
                style.textContent = `
                    @media (max-width: 767px) {
                        .masonry-grid[style*="column-count: 2"] .grid-item[data-fullwidth="true"] {
                            width: 100% !important;
                            column-span: all !important;
                            break-inside: avoid;
                            margin-bottom: 12px !important;
                        }
                        
                        .masonry-grid[style*="column-count: 2"] .grid-item[data-fullwidth="true"] .image-card {
                            width: 100% !important;
                            max-width: 100% !important;
                            border: 2px solid rgba(177, 76, 200, 0.3);
                            box-shadow: 0 4px 15px rgba(177, 76, 200, 0.2);
                            transform: translateY(-3px);
                        }
                        
                        /* ضبط الصور الأفقية 16:9 */
                        .masonry-grid[style*="column-count: 2"] .grid-item[data-ratio="16:9"] .gallery-image {
                            width: 100%;
                            max-height: 220px;
                            object-fit: contain;
                        }
                        
                        /* ضبط الصور المربعة 1:1 */
                        .masonry-grid[style*="column-count: 2"] .grid-item[data-ratio="1:1"] .gallery-image {
                            width: 100%;
                            max-height: 280px;
                            object-fit: contain;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // تطبيق السمات فقط في وضع العرض العريض للشاشات الصغيرة
            if (window.innerWidth <= 768 && currentViewMode === 'wide') {
                // تطبيق السمات على العناصر بناءً على أبعادها
                gridItems.forEach(item => {
                    // تجاهل العناصر المخفية
                    if (item.style.display === 'none') return;
                    
                    // الحصول على عنصر الصورة
                    const imgElement = item.querySelector('img.gallery-image');
                    if (!imgElement) return;
                    
                    // إعادة تعيين الأنماط
                    item.removeAttribute('data-fullwidth');
                    item.removeAttribute('data-ratio');
                    
                    // اكتشاف نسبة الأبعاد فقط للصور المحملة
                    if (imgElement.complete) {
                        const width = imgElement.naturalWidth;
                        const height = imgElement.naturalHeight;
                        
                        if (width && height) {
                            const ratio = width / height;
                            
                            // الصور بنسبة 16:9 (بهامش خطأ)
                            if (ratio >= 1.7 && ratio <= 1.8) {
                                item.setAttribute('data-fullwidth', 'true');
                                item.setAttribute('data-ratio', '16:9');
                            }
                            // الصور المربعة بنسبة 1:1 (بهامش خطأ)
                            else if (ratio >= 0.9 && ratio <= 1.1) {
                                item.setAttribute('data-fullwidth', 'true');
                                item.setAttribute('data-ratio', '1:1');
                            }
                        }
                    } else {
                        // إضافة مستمع تحميل للصور غير المحملة
                        imgElement.addEventListener('load', function() {
                            const width = this.naturalWidth;
                            const height = this.naturalHeight;
                            
                            if (width && height) {
                                const ratio = width / height;
                                
                                // الصور بنسبة 16:9 (بهامش خطأ)
                                if (ratio >= 1.7 && ratio <= 1.8) {
                                    item.setAttribute('data-fullwidth', 'true');
                                    item.setAttribute('data-ratio', '16:9');
                                    refreshMasonry();
                                }
                                // الصور المربعة بنسبة 1:1 (بهامش خطأ)
                                else if (ratio >= 0.9 && ratio <= 1.1) {
                                    item.setAttribute('data-fullwidth', 'true');
                                    item.setAttribute('data-ratio', '1:1');
                                    refreshMasonry();
                                }
                            }
                        });
                    }
                });
            }
        }

        /**
         * إعادة تعيين تخطيط الشبكة إلى الحالة الافتراضية
         * @param {Element} masonryGrid - عنصر شبكة ماسونري
         */
        function resetGridLayout(masonryGrid) {
            if (masonryGrid) {
                masonryGrid.style.display = '';
                masonryGrid.style.columnCount = '';
                masonryGrid.style.columnGap = '';
                masonryGrid.style.width = '';
            }
        }
        
        // تهيئة وظائف التخزين المحلي
        function initializeStorage() {
            // تهيئة الإعجابات
            if (!localStorage.getItem('imageLikes')) {
                localStorage.setItem('imageLikes', '{}');
            }
            if (!localStorage.getItem('userLikes')) {
                localStorage.setItem('userLikes', '[]');
            }
            
            // تهيئة المفضلات
            if (!localStorage.getItem('favorites')) {
                localStorage.setItem('favorites', '[]');
            }
        }
        
        // الحصول على معرف فريد للصورة من رابط URL
        function getImageId(url) {
            // استخراج الجزء الأخير من الرابط
            const parts = url.split('/');
            let filename = parts[parts.length - 1];
            
            // البحث عن أول معرف بصيغة UUID
            const uuidPattern = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
            const match = url.match(uuidPattern);
            
            if (match) {
                return match[0]; // إرجاع UUID
            }
            
            // إذا لم يوجد UUID، استخدم اسم الملف
            if (filename.includes('?')) {
                filename = filename.split('?')[0];
            }
            
            return filename;
        }
        
        // الحصول على عدد الإعجابات لصورة معينة
        function getLikesCount(imageUrl) {
            initializeStorage();
            const likes = JSON.parse(localStorage.getItem('imageLikes') || '{}');
            const imageId = getImageId(imageUrl);
            return likes[imageId] || 0;
        }
        
        // الحصول على قائمة الصور التي أعجب بها المستخدم
        function getUserLikes() {
            initializeStorage();
            return JSON.parse(localStorage.getItem('userLikes') || '[]');
        }
        
        // الحصول على قائمة المفضلات
        function getFavorites() {
            initializeStorage();
            return JSON.parse(localStorage.getItem('favorites') || '[]');
        }
        
        // تبديل حالة الإعجاب لصورة معينة
        function toggleLike(imageUrl, button) {
            console.log("تبديل إعجاب للصورة:", imageUrl);
            initializeStorage();
            
            const imageId = getImageId(imageUrl);
            const likes = JSON.parse(localStorage.getItem('imageLikes') || '{}');
            const userLikes = getUserLikes();
            
            // التحقق من الإعجاب بالرابط الكامل أو بالمعرف
            let userLikeIndex = userLikes.indexOf(imageUrl);
            if (userLikeIndex === -1) {
                userLikeIndex = userLikes.indexOf(imageId);
            }
            
            const hasLiked = userLikeIndex !== -1;
            console.log(`حالة الإعجاب الحالية: ${hasLiked ? 'معجب' : 'غير معجب'}`);
            
            // تبديل حالة الإعجاب
            if (hasLiked) {
                // إزالة الإعجاب
                userLikes.splice(userLikeIndex, 1);
                likes[imageId] = Math.max(0, (likes[imageId] || 0) - 1);
            } else {
                // إضافة إعجاب
                userLikes.push(imageId); // استخدام المعرف بدلاً من الرابط الكامل للتخزين
                likes[imageId] = (likes[imageId] || 0) + 1;
            }
            
            // حفظ التغييرات
            localStorage.setItem('imageLikes', JSON.stringify(likes));
            localStorage.setItem('userLikes', JSON.stringify(userLikes));
            
            // تحديث العرض المرئي
            const newHasLiked = !hasLiked;
            const likeCount = likes[imageId] || 0;
            
            // تحديث زر الإعجاب والعدد
            const likeIcon = button.querySelector('.fa-heart');
            const countElement = button.nextElementSibling;
            
            if (likeIcon) {
                if (newHasLiked) {
                    button.classList.add('active');
                    likeIcon.style.color = 'white';
                    likeIcon.style.webkitTextStroke = '0';
                } else {
                    button.classList.remove('active');
                    likeIcon.style.color = 'transparent';
                    likeIcon.style.webkitTextStroke = '1px white';
                }
                
                button.classList.add('pulse');
                setTimeout(() => button.classList.remove('pulse'), 500);
            }
            
            if (countElement) {
                countElement.textContent = likeCount;
            }
            
            // تحديث جميع الأزرار للصورة نفسها
            document.querySelectorAll(`.like-btn[data-url="${imageUrl}"]`).forEach(btn => {
                if (btn !== button) {
                    const btnIcon = btn.querySelector('.fa-heart');
                    const btnCount = btn.nextElementSibling;
                    
                    if (btnIcon) {
                        if (newHasLiked) {
                            btn.classList.add('active');
                            btnIcon.style.color = 'white';
                            btnIcon.style.webkitTextStroke = '0';
                        } else {
                            btn.classList.remove('active');
                            btnIcon.style.color = 'transparent';
                            btnIcon.style.webkitTextStroke = '1px white';
                        }
                    }
                    
                    if (btnCount) {
                        btnCount.textContent = likeCount;
                    }
                }
            });
            
            return likeCount;
        }
        
        // تبديل حالة المفضلة لصورة معينة
        function toggleFavorite(imageUrl, button) {
            console.log("تبديل مفضلة للصورة:", imageUrl);
            
            const imageId = getImageId(imageUrl);
            const favorites = getFavorites();
            
            // التحقق أولاً باستخدام الرابط الكامل (للتوافق مع الكود القديم)
            let favoriteIndex = favorites.indexOf(imageUrl);
            let isFavorite = favoriteIndex !== -1;
            
            // إذا لم نجد في المفضلة، جرب البحث باستخدام معرف الصورة
            if (!isFavorite) {
                favoriteIndex = favorites.indexOf(imageId);
                isFavorite = favoriteIndex !== -1;
            }
            
            // تبديل حالة المفضلة
            if (isFavorite) {
                // إزالة من المفضلة
                favorites.splice(favoriteIndex, 1);
            } else {
                // إضافة للمفضلة - استخدام المعرف بدلاً من الرابط الكامل
                favorites.push(imageId);
            }
            
            // حفظ التغييرات
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            // تحديث العرض المرئي
            const newIsFavorite = !isFavorite;
            
            // تحديث زر المفضلة
            const favoriteIcon = button.querySelector('.fa-bookmark');
            
            if (favoriteIcon) {
                if (newIsFavorite) {
                    button.classList.add('active');
                    favoriteIcon.style.color = 'white';
                    favoriteIcon.style.webkitTextStroke = '0';
                } else {
                    button.classList.remove('active');
                    favoriteIcon.style.color = 'transparent';
                    favoriteIcon.style.webkitTextStroke = '1px white';
                }
                
                button.classList.add('pulse');
                setTimeout(() => button.classList.remove('pulse'), 500);
            }
            
            // تحديث جميع الأزرار للصورة نفسها
            document.querySelectorAll(`.favorite-btn[data-url="${imageUrl}"]`).forEach(btn => {
                if (btn !== button) {
                    const btnIcon = btn.querySelector('.fa-bookmark');
                    
                    if (btnIcon) {
                        if (newIsFavorite) {
                            btn.classList.add('active');
                            btnIcon.style.color = 'white';
                            btnIcon.style.webkitTextStroke = '0';
                        } else {
                            btn.classList.remove('active');
                            btnIcon.style.color = 'transparent';
                            btnIcon.style.webkitTextStroke = '1px white';
                        }
                    }
                }
            });
            
            return newIsFavorite;
        }
        
        // تعيين الصورة كصورة ملف شخصي
        function setProfileImage(imageUrl) {
            // استدعاء مربع حوار التأكيد مباشرة
            showProfileImageConfirmation(imageUrl);
            return true;
        }
        
        /**
         * عرض مربع حوار تأكيد مخصص لتغيير الصورة الشخصية
         * @param {string} imageUrl - رابط الصورة المراد تعيينها كصورة شخصية
         */
        function showProfileImageConfirmation(imageUrl) {
            // الحصول على اللغة الحالية
            const currentLang = localStorage.getItem('language') || 'ar';
            
            // تحديد النصوص حسب اللغة
            const texts = currentLang === 'en' ? {
                title: 'Change Profile Picture',
                message: 'Are you sure you want to set this image as your profile picture?',
                confirmButton: 'Yes, Change it',
                cancelButton: 'Cancel'
            } : {
                title: 'تغيير الصورة الشخصية',
                message: 'هل أنت متأكد من رغبتك في تعيين هذه الصورة كصورة ملفك الشخصي؟',
                confirmButton: 'نعم، قم بالتغيير',
                cancelButton: 'إلغاء'
            };
            
            // إنشاء عنصر الخلفية
            const confirmOverlay = document.createElement('div');
            confirmOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(3px);
            `;
            
            // إنشاء صورة مصغرة للعرض في مربع التأكيد
            const thumbnailContainer = document.createElement('div');
            thumbnailContainer.style.cssText = `
                width: 120px;
                height: 120px;
                border-radius: 50%;
                overflow: hidden;
                margin: 0 auto 20px auto;
                border: 3px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            `;
            
            // إنشاء الصورة المصغرة
            const thumbnail = document.createElement('img');
            thumbnail.style.cssText = `
                width: 100%;
                height: 100%;
                object-fit: cover;
            `;
            thumbnail.src = imageUrl;
            thumbnailContainer.appendChild(thumbnail);
            
            // إنشاء مربع الحوار
            const confirmBox = document.createElement('div');
            confirmBox.style.cssText = `
                background: linear-gradient(135deg, rgba(25, 5, 30, 0.95), rgba(45, 15, 50, 0.95));
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 15px;
                padding: 25px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
                transform: translateY(20px);
                opacity: 0;
                transition: all 0.3s ease;
            `;
            
            // إضافة أنيميشن الظهور
            setTimeout(() => {
                confirmBox.style.transform = 'translateY(0)';
                confirmBox.style.opacity = '1';
            }, 50);
            
            // إنشاء العنوان
            const title = document.createElement('h3');
            title.textContent = texts.title;
            title.style.cssText = `
                color: #d5c3e8;
                margin: 0 0 20px 0;
                font-size: 22px;
                font-weight: 600;
            `;
            
            // إنشاء الرسالة
            const message = document.createElement('p');
            message.textContent = texts.message;
            message.style.cssText = `
                color: rgba(255, 255, 255, 0.85);
                margin: 0 0 25px 0;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            // إنشاء حاوية الأزرار
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                justify-content: center;
                gap: 15px;
                ${currentLang === 'ar' ? 'flex-direction: row-reverse;' : ''}
            `;
            
            // إنشاء زر التأكيد
            const confirmButton = document.createElement('button');
            confirmButton.textContent = texts.confirmButton;
            confirmButton.style.cssText = `
                background: linear-gradient(45deg, #9c65a3, #ba7fc2);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(186, 127, 194, 0.3);
            `;
            
            // تأثيرات الزر
            confirmButton.addEventListener('mouseenter', () => {
                confirmButton.style.transform = 'translateY(-2px)';
                confirmButton.style.boxShadow = '0 6px 15px rgba(186, 127, 194, 0.4)';
            });
            
            confirmButton.addEventListener('mouseleave', () => {
                confirmButton.style.transform = 'translateY(0)';
                confirmButton.style.boxShadow = '0 4px 12px rgba(186, 127, 194, 0.3)';
            });
            
            // إنشاء زر الإلغاء
            const cancelButton = document.createElement('button');
            cancelButton.textContent = texts.cancelButton;
            cancelButton.style.cssText = `
                background: rgba(255, 255, 255, 0.1);
                color: rgba(255, 255, 255, 0.8);
                border: 1px solid rgba(255, 255, 255, 0.2);
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            `;
            
            // تأثيرات زر الإلغاء
            cancelButton.addEventListener('mouseenter', () => {
                cancelButton.style.background = 'rgba(255, 255, 255, 0.15)';
            });
            
            cancelButton.addEventListener('mouseleave', () => {
                cancelButton.style.background = 'rgba(255, 255, 255, 0.1)';
            });
            
            // دالة إغلاق مربع الحوار
            const closeConfirmDialog = () => {
                confirmBox.style.transform = 'translateY(20px)';
                confirmBox.style.opacity = '0';
                
                setTimeout(() => {
                    document.body.removeChild(confirmOverlay);
                }, 300);
            };
            
            // إضافة معالجات الأحداث للأزرار
            confirmButton.addEventListener('click', () => {
                closeConfirmDialog();
                // تنفيذ تغيير الصورة الشخصية
                applyProfileImageChange(imageUrl);
            });
            
            cancelButton.addEventListener('click', closeConfirmDialog);
            
            // إضافة معالج حدث للنقر خارج مربع الحوار
            confirmOverlay.addEventListener('click', (e) => {
                if (e.target === confirmOverlay) {
                    closeConfirmDialog();
                }
            });
            
            // تجميع العناصر
            buttonContainer.appendChild(confirmButton);
            buttonContainer.appendChild(cancelButton);
            
            confirmBox.appendChild(thumbnailContainer);
            confirmBox.appendChild(title);
            confirmBox.appendChild(message);
            confirmBox.appendChild(buttonContainer);
            confirmOverlay.appendChild(confirmBox);
            
            // إضافة مربع الحوار للصفحة
            document.body.appendChild(confirmOverlay);
        }
        
        /**
         * تطبيق تغيير الصورة الشخصية بعد الموافقة
         * @param {string} imageUrl - رابط الصورة المراد تعيينها
         */
        function applyProfileImageChange(imageUrl) {
            // تخزين رابط الصورة في localStorage
            localStorage.setItem('userAvatar', imageUrl);
            
            // تحديث الصورة المعروضة في الواجهة
            const userAvatar = document.getElementById('user-avatar');
            if (userAvatar) {
                userAvatar.src = imageUrl;
            }
            
            // تأكد من وجود اسم المستخدم
            const userName = document.getElementById('user-name');
            if (userName && (!userName.textContent || userName.textContent === 'زائر')) {
                // إذا لم يكن المستخدم مسجلاً، أنشئ اسم مستخدم افتراضي
                const defaultUsername = 'مستخدم_' + Math.floor(Math.random() * 1000);
                userName.textContent = defaultUsername;
                
                // حفظ معلومات المستخدم
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                currentUser.username = defaultUsername;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
            
            // عرض إشعار نجاح مخصص
            const currentLang = localStorage.getItem('language') || 'ar';
            const successText = currentLang === 'en' ? 
                'Profile picture updated successfully!' : 
                'تم تحديث الصورة الشخصية بنجاح!';
            
            // إنشاء إشعار نجاح صغير بتصميم متوافق مع الموقع
            const successNotification = document.createElement('div');
            successNotification.style.cssText = `
                position: fixed;
                bottom: 20px;
                ${currentLang === 'ar' ? 'left: 20px;' : 'right: 20px;'}
                background: linear-gradient(45deg, #4a8a5e, #60b275);
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                z-index: 1000;
                font-size: 14px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease;
            `;
            
            successNotification.textContent = successText;
            document.body.appendChild(successNotification);
            
            // عرض الإشعار
            setTimeout(() => {
                successNotification.style.opacity = '1';
                successNotification.style.transform = 'translateY(0)';
            }, 100);
            
            // إخفاء الإشعار بعد 3 ثوان
            setTimeout(() => {
                successNotification.style.opacity = '0';
                successNotification.style.transform = 'translateY(20px)';
                
                // إزالة الإشعار من DOM بعد انتهاء الأنيميشن
                setTimeout(() => {
                    document.body.removeChild(successNotification);
                }, 300);
            }, 3000);
        }
        
        // مشاركة الصورة
        function shareImage(url, title) {
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: 'شاهد هذه الصورة الرائعة من معرض ArtWall.Ai',
                    url: url
                })
                .then(() => console.log('تمت المشاركة بنجاح'))
                .catch((error) => console.log('خطأ في المشاركة:', error));
            } else {
                // نسخ الرابط للمتصفحات التي لا تدعم Share API
                const tempInput = document.createElement('input');
                document.body.appendChild(tempInput);
                tempInput.value = url;
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('تم نسخ رابط الصورة. يمكنك مشاركته الآن.');
            }
        }
        
        // وظيفة للحصول على مفتاح الفئة للترجمة
        function getCategoryKey(category) {
            // تحويل الفئة إلى مفتاح مناسب في كائن الترجمة
            const categoryMap = {
                'animals': 'animals',
                'حيوانات': 'animals',
                'birds': 'birds',
                'طيور': 'birds',
                'anime': 'anime',
                'أنمي': 'anime',
                'creativity': 'creativity',
                'إبداع': 'creativity',
                'technology': 'technology',
                'تكنولوجيا': 'technology',
                'world': 'world',
                'عالم': 'world',
                'space': 'space',
                'فضاء': 'space',
                'classic': 'classic',
                'كلاسيكي': 'classic',
                'all': 'allImages',
                'جميع الصور': 'allImages'
            };
            
            // إرجاع المفتاح المناسب أو القيمة الأصلية
            return categoryMap[category.toLowerCase()] || category;
        }
        
        // وظيفة للبحث عن الصور
        function searchImages(query) {
            console.log('البحث عن:', query);
            query = query.trim().toLowerCase();
            
            if (!query) {
                // إذا كان حقل البحث فارغاً، أعد عرض جميع الصور مع تطبيق الفلاتر الحالية
                applyFilters();
                return;
            }
            
            const currentLang = localStorage.getItem('language') || 'ar';
            const gridItems = document.querySelectorAll('.grid-item');
            
            gridItems.forEach(item => {
                // البحث في كلتا اللغتين
                const titleAr = item.getAttribute('data-title-ar')?.toLowerCase() || '';
                const titleEn = item.getAttribute('data-title-en')?.toLowerCase() || '';
                const categoryAr = item.getAttribute('data-category-ar')?.toLowerCase() || '';
                const categoryEn = item.getAttribute('data-category-en')?.toLowerCase() || '';
                
                // البحث في اللغتين
                const titleMatch = titleAr.includes(query) || titleEn.includes(query);
                const categoryMatch = categoryAr.includes(query) || categoryEn.includes(query);
                
                // إخفاء/إظهار العناصر بناءً على نتيجة البحث
                if (titleMatch || categoryMatch) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // إعادة ترتيب المعرض بعد البحث
            refreshMasonry();
        }
        
        // ترجمات لنصوص الموقع
        const translations = {
            ar: {
                // القائمة الجانبية
                myAccount: 'حسابي',
                home: 'الصفحة الرئيسية',
                myProfile: 'الملف الشخصي',
                myFavorites: 'المفضلة',
                imageDimensions: 'أبعاد الصور',
                viewMode: 'طريقة العرض',
                tools: 'أدوات',
                language: 'اللغة',
                
                // أزرار الفئات
                allImages: 'جميع الصور',
                animals: 'حيوانات',
                birds: 'طيور',
                anime: 'أنمي',
                creativity: 'إبداع',
                technology: 'تكنولوجيا',
                world: 'عالم',
                space: 'فضاء',
                classic: 'كلاسيكي',
                
                // حقل البحث
                searchPlaceholder: 'ابحث عن اسم صورة...'
            },
            en: {
                // القائمة الجانبية
                myAccount: 'My Account',
                home: 'Home',
                myProfile: 'My Profile',
                myFavorites: 'Favorites',
                imageDimensions: 'Image Dimensions',
                viewMode: 'View Mode',
                tools: 'Tools',
                language: 'Language',
                
                // أزرار الفئات
                allImages: 'All Images',
                animals: 'Animals',
                birds: 'Birds',
                anime: 'Anime',
                creativity: 'Creativity',
                technology: 'Technology',
                world: 'World',
                space: 'Space',
                classic: 'Classic',
                
                // حقل البحث
                searchPlaceholder: 'Search for an image name...'
            }
        };
        
        // وظيفة تبديل اللغة (مبسطة)
        function switchLanguage(lang) {
            console.log('تبديل اللغة إلى:', lang);
            
            // تحديث خيارات اللغة
            document.querySelectorAll('.lang-option').forEach(option => {
                if (option.getAttribute('data-lang') === lang) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // تخزين اللغة في localStorage
            localStorage.setItem('language', lang);
            
            // تحديث اتجاه الصفحة حسب اللغة
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // إعادة ضبط حجم الخلفية المتحركة للقائمة
            const langMenu = document.getElementById('languageMenu');
            if (langMenu) {
                // إعادة تطبيق الخصائص للخلفية المتحركة
                setTimeout(() => {
                    if (langMenu.offsetHeight > 0) {
                        // ضمان أن الخلفية المتحركة تغطي كامل القائمة
                        const menuWidth = langMenu.offsetWidth;
                        const menuHeight = langMenu.offsetHeight;
                        langMenu.style.setProperty('--menu-width', menuWidth + 'px');
                        langMenu.style.setProperty('--menu-height', menuHeight + 'px');
                    }
                }, 50); // تأخير بسيط للسماح بإعادة الرسم
            }
            
            // إغلاق القائمة المنسدلة
            var menu = document.getElementById('languageMenu');
            if (menu) {
                menu.classList.remove('show');
            }
            
            // تطبيق الترجمات
            applyTranslations(lang);
            
            // تحديث نص زر اللغة
            const langText = document.querySelector('#langToggleBtn span[data-i18n="language"]');
            if (langText) {
                langText.textContent = translations[lang]['language'] || (lang === 'ar' ? 'اللغة' : 'Language');
            }
        }
        
        // وظيفة تطبيق الترجمات
        function applyTranslations(lang) {
            const texts = translations[lang] || translations.ar;
            
            // تحديث جميع العناصر التي تحتوي على سمة data-i18n
            document.querySelectorAll('[data-i18n]').forEach(elem => {
                const key = elem.getAttribute('data-i18n');
                if (texts[key]) {
                    // التحقق مما إذا كان العنصر زر تصفية به أيقونة
                    if (elem.classList.contains('filter-btn')) {
                        // العثور على عنصر النص داخل الزر والحفاظ على الأيقونة
                        const textSpan = elem.querySelector('.category-text');
                        if (textSpan) {
                            textSpan.textContent = texts[key];
                        } else {
                            elem.textContent = texts[key];
                        }
                    } else {
                        // العناصر العادية الأخرى
                        elem.textContent = texts[key];
                    }
                }
            });
            
            // تحديث placeholder للحقول
            document.querySelectorAll('[data-i18n-placeholder]').forEach(elem => {
                const key = elem.getAttribute('data-i18n-placeholder');
                if (texts[key]) {
                    elem.placeholder = texts[key];
                }
            });
            
            // تحديث عناوين الصور والفئات حسب اللغة المحددة
            document.querySelectorAll('.grid-item').forEach(item => {
                // تحديث عنوان الصورة
                const titleBadge = item.querySelector('.image-title-badge');
                if (titleBadge) {
                    const titleKey = lang === 'ar' ? 'data-title-ar' : 'data-title-en';
                    const title = item.getAttribute(titleKey) || '';
                    if (title) {
                        titleBadge.textContent = title;
                        titleBadge.setAttribute('title', title);
                    }
                }
                
                // تحديث فئة الصورة
                const categoryBadge = item.querySelector('.category-badge');
                if (categoryBadge) {
                    const categoryKey = lang === 'ar' ? 'data-category-ar' : 'data-category-en';
                    const category = item.getAttribute(categoryKey) || '';
                    if (category) {
                        categoryBadge.textContent = category;
                    }
                }
            });
        }
        
        // وظيفة تهيئة قائمة اللغة المنسدلة (مبسطة للغاية)
        function initLanguageDropdown() {
            console.log('تهيئة زر اللغة في المعرض البسيط');
            
            // العناصر المطلوبة
            var langBtn = document.getElementById('langToggleBtn');
            var menu = document.getElementById('languageMenu');
            
            // إضافة حدث النقر على زر اللغة
            if (langBtn && menu) {
                // التعامل مع نقرات زر اللغة
                langBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('تم النقر على زر اللغة في المعرض');
                    
                    // تبديل حالة القائمة
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                    } else {
                        // تحديد ما إذا كان يجب عرض القائمة فوق أم تحت الزر
                        const btnRect = langBtn.getBoundingClientRect();
                        const bottomSpace = window.innerHeight - btnRect.bottom;
                        
                        // تقدير ارتفاع القائمة بناءً على عدد اللغات (كل لغة ~40px)
                        const itemCount = menu.querySelectorAll('a').length;
                        const estimatedMenuHeight = itemCount * 40 + 10; // 10px إضافية للهوامش
                        
                        // إذا كانت المساحة المتبقية أقل من الارتفاع المقدر للقائمة، أو قريبة من حافة الشاشة، عرضها فوق الزر
                        const safetyMargin = 20; // هامش أمان إضافي بالبيكسل
                        if (bottomSpace < estimatedMenuHeight + safetyMargin || 
                            btnRect.bottom + estimatedMenuHeight > window.innerHeight - safetyMargin) {
                            // عرض القائمة فوق الزر
                            menu.style.bottom = '100%';
                            menu.style.top = 'auto';
                            menu.style.marginBottom = '5px';
                            menu.style.marginTop = '0';
                            // تطبيق أنيميشن من أعلى
                            menu.style.animation = 'fadeInFromTop 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                            // إضافة سمة لتتبع الموضع
                            menu.setAttribute('data-position', 'top');
                        } else {
                            // عرض القائمة تحت الزر (الوضع الافتراضي)
                            menu.style.top = '100%';
                            menu.style.bottom = 'auto';
                            menu.style.marginTop = '5px';
                            menu.style.marginBottom = '0';
                            // تطبيق أنيميشن من أسفل
                            menu.style.animation = 'fadeInFromBottom 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                            // إضافة سمة لتتبع الموضع
                            menu.setAttribute('data-position', 'bottom');
                        }
                        
                        // جعل عرض القائمة مساويًا لعرض الزر
                        menu.style.width = btnRect.width + 'px';
                        
                        menu.classList.add('show');
                    }
                };
                
                // إغلاق القائمة عند النقر في أي مكان آخر
                document.onclick = function(e) {
                    if (e.target != langBtn && !menu.contains(e.target)) {
                        menu.classList.remove('show');
                    }
                };
                
                // تعيين اللغة الحالية
                const currentLang = localStorage.getItem('language') || 'ar';
                document.querySelectorAll('.lang-option').forEach(option => {
                    if (option.getAttribute('data-lang') === currentLang) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة ذاكرة التخزين المحلي
            initializeStorage();
            
            // تحديث معلومات المستخدم
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            
            // تحديث صورة المستخدم إذا وجدت
            const storedAvatar = localStorage.getItem('userAvatar');
            if (storedAvatar) {
                userAvatar.src = storedAvatar;
            }
            
            // تحديث اسم المستخدم إذا كان مسجلاً
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (currentUser && currentUser.username) {
                userName.textContent = currentUser.username;
            } else {
                userName.textContent = 'زائر';
            }
            
            // تهيئة القائمة
            initMenuToggle();
            
            // تهيئة قائمة اللغة المنسدلة
            initLanguageDropdown();
            
            // تهيئة زر تفعيل/إلغاء تفعيل المرشحات - التعديل A
            initFilterToggle();
            
            // تهيئة فلاتر الأبعاد والفئات
            window.currentCategoryFilter = 'all';
            window.currentDimensionFilter = 'all';
            
            // إضافة مستمعي الأحداث لأزرار تبديل اللغة
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchLanguage(this.getAttribute('data-lang'));
                });
            });
            
            // استعادة طريقة العرض المحفوظة
            const savedViewMode = localStorage.getItem('viewMode') || 'default';
            
            // تطبيق الوضع المحفوظ مع تأخير بسيط للتأكد من تحميل كافة الصور
            setTimeout(() => {
                setGridColumns(savedViewMode);
                
                // تحديث Masonry بعد وقت قصير للتأكد من تطبيق التنسيق بشكل صحيح
                setTimeout(() => {
                    refreshMasonry();
                }, 200);
            }, 100);
            
            // استعادة اللغة المحفوظة أو الافتراضية
            const savedLang = localStorage.getItem('language') || 'ar';
            switchLanguage(savedLang);
            
            // إضافة مستمع الحدث لحقل البحث
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // مستمع للكتابة المباشرة
                searchInput.addEventListener('input', function() {
                    searchImages(this.value);
                });
                
                // مستمع للضغط على مفتاح Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchImages(this.value);
                    }
                });
            }
            
            // التأكد من تحميل بيانات الصور
            if (!window.imageData || !Array.isArray(window.imageData)) {
                console.error('بيانات الصور غير متوفرة!');
                return;
            }
            
            console.log('تم العثور على', window.imageData.length, 'صورة، جاري التحميل...');
            
            // الحصول على حاوية المعرض
            const masonryGrid = document.querySelector('.masonry-grid');
            
            // إنشاء بطاقات الصور
            window.imageData.forEach(imageData => {
                // إنشاء عنصر بطاقة الصورة
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                
                // استخراج العنوان المناسب بناءً على اللغة المحددة
                let title = '';
                if (typeof imageData.title === 'object') {
                    // احفظ عنوان الصورة بكلتا اللغتين كسمات للعنصر
                    gridItem.setAttribute('data-title-ar', imageData.title.ar || '');
                    gridItem.setAttribute('data-title-en', imageData.title.en || '');
                    
                    // العنوان المعروض بناءً على اللغة الحالية
                    const currentLang = localStorage.getItem('language') || 'ar';
                    title = imageData.title[currentLang] || imageData.title.ar || imageData.title.en || imageData.alt || 'صورة';
                } else {
                    // إذا كان العنوان نصًا بسيطًا، احفظه بنفس القيمة لكلتا اللغتين
                    const simpleTitle = imageData.title || imageData.alt || 'صورة';
                    gridItem.setAttribute('data-title-ar', simpleTitle);
                    gridItem.setAttribute('data-title-en', simpleTitle);
                    title = simpleTitle;
                }
                
                // استخراج الفئة بناءً على اللغة المحددة
                let category = '';
                if (imageData.category) {
                    // التعامل مع الفئة ككائن متعدد اللغات
                    if (typeof imageData.category === 'object') {
                        // احفظ الفئة بكلتا اللغتين كسمات للعنصر
                        gridItem.setAttribute('data-category-ar', imageData.category.ar || '');
                        gridItem.setAttribute('data-category-en', imageData.category.en || '');
                        
                        // الفئة المعروضة بناءً على اللغة الحالية
                        const currentLang = localStorage.getItem('language') || 'ar';
                        category = imageData.category[currentLang] || imageData.category.ar || imageData.category.en || '';
                    } else {
                        // إذا كانت الفئة نصًا بسيطًا
                        const rawCategory = imageData.category.toLowerCase();
                        
                        // استخراج الفئة الرئيسية قبل أي شرطة
                        const categoryMatch = rawCategory.match(/^([^-]+)/);
                        if (categoryMatch) {
                            category = categoryMatch[1].trim();
                        } else {
                            category = rawCategory;
                        }
                        
                        // ترجمة الفئة
                        const categoryKey = getCategoryKey(category);
                        
                        // احفظ الفئة بكلتا اللغتين
                        gridItem.setAttribute('data-category-ar', translations.ar[categoryKey] || category);
                        gridItem.setAttribute('data-category-en', translations.en[categoryKey] || category);
                        
                        // الفئة المعروضة بناءً على اللغة الحالية
                        const currentLang = localStorage.getItem('language') || 'ar';
                        category = translations[currentLang][categoryKey] || category;
                    }
                    
                    // استخدم قيمة الفئة الأصلية كمعرف للفلترة
                    const filterCategory = typeof imageData.category === 'object' 
                        ? getCategoryKey(imageData.category.ar || imageData.category.en || '')
                        : getCategoryKey(imageData.category);
                    
                    gridItem.setAttribute('data-category', filterCategory);
                }
                
                // التحقق من حالة الإعجاب والمفضلة
                const imageId = getImageId(imageData.url);
                const likesCount = getLikesCount(imageData.url);
                const userLikes = getUserLikes();
                const favorites = getFavorites();
                
                const hasLiked = userLikes.includes(imageId) || userLikes.includes(imageData.url);
                const isFavorite = favorites.includes(imageId) || favorites.includes(imageData.url);
                
                // إضافة معرف فريد للعنصر لتتبع حالة الإخفاء أثناء التصفية
                gridItem.setAttribute('data-id', imageId);
                
                // إضافة سمة الأبعاد للعنصر لتحسين الفلترة
                if (imageData.dimension) {
                    // إذا كانت البيانات تحتوي على معلومات الأبعاد
                    gridItem.setAttribute('data-dimension', imageData.dimension);
                    console.log(`تعيين بُعد للصورة ${title}: ${imageData.dimension}`);
                } else {
                    // لا توجد معلومات أبعاد في البيانات، سنستخدم الفلتر التقليدي
                    console.log(`لا توجد معلومات أبعاد للصورة: ${title}`);
                }
                
                // إنشاء محتوى البطاقة
                gridItem.innerHTML = `
                    <div class="image-card">
                        <div class="image-header">
                            <div class="category-badge">${category}</div>
                            <div class="image-title-badge" title="${title}">${title}</div>
                        </div>
                        
                        <div class="left-actions">
                            <button class="action-btn view-btn" onclick="viewImage('${imageData.url}', '${title}')" title="عرض الصورة">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn like-btn ${hasLiked ? 'active' : ''}" data-url="${imageData.url}" onclick="toggleLike('${imageData.url}', this)" title="إعجاب">
                                <i class="fas fa-heart" style="${hasLiked ? 'color: white; -webkit-text-stroke: 0;' : 'color: transparent; -webkit-text-stroke: 1px white;'}"></i>
                            </button>
                            <span class="like-count">${likesCount}</span>
                        </div>
                        
                        <img 
                            src="${imageData.url}" 
                            alt="${imageData.alt || title}" 
                            class="gallery-image"
                            loading="lazy"
                            onerror="this.src='Imges/All img icon.png'; this.style.padding='20px'; this.style.backgroundColor='#1a0b20';"
                        />
                        
                        <div class="bottom-actions">
                            <button class="action-btn share-btn" onclick="shareImage('${imageData.url}', '${title}')" title="مشاركة">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="action-btn download-btn" onclick="window.downloadImage(event, '${imageData.url}')" title="تنزيل">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="action-btn profile-btn" onclick="setProfileImage('${imageData.url}')" title="تعيين كصورة ملف شخصي">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="action-btn favorite-btn ${isFavorite ? 'active' : ''}" data-url="${imageData.url}" onclick="toggleFavorite('${imageData.url}', this)" title="إضافة للمفضلة">
                                <i class="fas fa-bookmark" style="${isFavorite ? 'color: white; -webkit-text-stroke: 0;' : 'color: transparent; -webkit-text-stroke: 1px white;'}"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // إضافة البطاقة إلى الشبكة
                masonryGrid.appendChild(gridItem);
            });
            
            // تطبيق Masonry بعد تحميل جميع الصور
            imagesLoaded(masonryGrid, function() {
                new Masonry(masonryGrid, {
                    itemSelector: '.grid-item',
                    columnWidth: '.grid-sizer',
                    gutter: '.gutter-sizer',
                    percentPosition: true
                });
                
                console.log('تم تطبيق Masonry بنجاح');
            });
            
            // إضافة مستمعي أحداث لأزرار التصفية
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filterCategory = this.getAttribute('data-category');
                    filterByCategory(filterCategory);
                });
            });
        });
        
        // وظيفة عرض الصورة في عرض كامل الشاشة
        function viewImage(url, title) {
            // استخراج معلومات الصورة إذا كانت متوفرة
            let imageCategory = '';
            const currentImageData = window.imageData.find(img => img.url === url);
            
            if (currentImageData && currentImageData.category) {
                // التعامل مع تنسيق "نوع - فئة فرعية"
                if (typeof currentImageData.category === 'string' && currentImageData.category.includes(' - ')) {
                    const categoryParts = currentImageData.category.split(' - ');
                    imageCategory = categoryParts[0]; // استخدام الفئة الرئيسية فقط
                } else {
                    imageCategory = currentImageData.category;
                }
            }
            
            const viewer = document.createElement('div');
            viewer.className = 'fullscreen-viewer';
            
            // الحصول على عدد الإعجابات إذا كانت الدالة متوفرة
            let likesCount = 0;
            if (typeof window.getLikesCount === 'function') {
                likesCount = window.getLikesCount(url);
            }
            
            // معرفة ما إذا كان المستخدم قد أعجب بالصورة
            const hasLiked = typeof window.getUserLikes === 'function' && window.getUserLikes().includes(url);
            
            // معرفة ما إذا كانت الصورة في المفضلة
            const isFavorite = typeof window.getFavorites === 'function' && window.getFavorites().includes(url);
            
            // أولاً إنشاء محتوى العارض
            viewer.innerHTML = `
                <div class="viewer-content" style="position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                    
                    <!-- زر الخروج في أعلى يمين الشاشة -->
                    <button class="close-btn" style="position: fixed; top: 20px; right: 20px; background-color: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9999;">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <!-- معلومات الصورة في الأعلى -->
                    <div class="image-info" style="display: flex; flex-direction: column; align-items: center; margin-bottom: 15px; margin-top: 70px; z-index: 100;">
                        <div class="category-badge" style="background-color: rgba(177, 76, 200, 0.8); color: white; padding: 4px 10px; border-radius: 4px; font-size: 14px; text-align: center; backdrop-filter: blur(2px); margin-bottom: 5px;">
                            ${imageCategory || 'بدون تصنيف'}
                        </div>
                        
                        <div class="image-title-badge" style="background-color: rgba(0, 0, 0, 0.6); color: white; padding: 4px 10px; border-radius: 4px; font-size: 14px; text-align: center; backdrop-filter: blur(2px); max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${title}
                        </div>
                    </div>
                    
                    <!-- الصورة المعروضة -->
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 30px;">
                        <img src="${url}" alt="${title}" class="viewer-image" style="max-width: 85%; max-height: 60vh; object-fit: contain; margin: 0 auto; display: block; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4);" />
                    </div>
                    
                    <!-- جميع أزرار التفاعل أسفل الصورة - تم تحسين التنسيق وتثبيت الموضع -->
                    <div class="all-image-actions" style="display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 12px; margin-top: 10px; background-color: rgba(90, 24, 107, 0.7); padding: 10px 15px; border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 100; direction: ltr; /* تثبيت اتجاه الأزرار بغض النظر عن اللغة */;">
                        <!-- زر العرض - الآن يستخدم وظيفة جديدة لعرض الصورة بملء الشاشة -->
                        <button class="action-btn view-btn" onclick="viewImageFullscreen('${url}', '${title}')" title="عرض الصورة بملء الشاشة" style="background-color: rgba(58, 16, 69, 0.9); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-eye"></i>
                        </button>
                        
                        <!-- زر الإعجاب -->
                        <button class="action-btn like-btn ${hasLiked ? 'active' : ''}" data-url="${url}" onclick="toggleLike('${url}', this)" title="إعجاب" style="background-color: rgba(58, 16, 69, 0.9); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-heart" style="${hasLiked ? 'color: white; -webkit-text-stroke: 0;' : 'color: transparent; -webkit-text-stroke: 1px white;'}"></i>
                        </button>
                        
                        <!-- عدد الإعجابات -->
                        <span class="like-count" style="background-color: rgba(58, 16, 69, 0.9); color: white; border-radius: 20px; padding: 0 12px; display: flex; align-items: center; justify-content: center; height: 30px; min-width: 35px; text-align: center;">${likesCount}</span>
                        
                        <!-- زر المشاركة -->
                        <button class="action-btn share-btn" onclick="shareImage('${url}', '${title}')" title="مشاركة" style="background-color: rgba(58, 16, 69, 0.9); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        
                        <!-- زر التنزيل -->
                        <button class="action-btn download-btn" onclick="window.downloadImage(event, '${url}')" title="تنزيل" style="background-color: rgba(58, 16, 69, 0.9); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-download"></i>
                        </button>
                        
                        <!-- زر تعيين كصورة ملف شخصي -->
                        <button class="action-btn profile-btn" onclick="setProfileImage('${url}')" title="تعيين كصورة ملف شخصي" style="background-color: rgba(58, 16, 69, 0.9); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-user"></i>
                        </button>
                        
                        <!-- زر المفضلة -->
                        <button class="action-btn favorite-btn ${isFavorite ? 'active' : ''}" data-url="${url}" onclick="toggleFavorite('${url}', this)" title="إضافة للمفضلة" style="background-color: rgba(58, 16, 69, 0.9); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                            <i class="fas fa-bookmark" style="${isFavorite ? 'color: white; -webkit-text-stroke: 0;' : 'color: transparent; -webkit-text-stroke: 1px white;'}"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // لا نحتاج إلى أزرار سفلية منفصلة بعد الآن لأننا وضعناها مباشرة أسفل الصورة
            
            document.body.appendChild(viewer);
            
            // إضافة مستمع لإغلاق العارض
            viewer.querySelector('.close-btn').addEventListener('click', function() {
                viewer.remove();
            });
            
            // إغلاق العارض عند النقر خارج الصورة
            viewer.addEventListener('click', function(e) {
                if (e.target === viewer) {
                    viewer.remove();
                }
            });
            
            // إغلاق العارض عند الضغط على مفتاح Escape
            document.addEventListener('keydown', function escapeFn(e) {
                if (e.key === 'Escape') {
                    viewer.remove();
                    document.removeEventListener('keydown', escapeFn); // إزالة المستمع
                }
            });
            
            // لم نعد بحاجة إلى إضافة مستمعات أحداث مخصصة للأزرار
            // لأن الأزرار تحتوي بالفعل على onclick يتضمن الدوال المناسبة
        }
        
        /**
         * وظيفة جديدة لعرض الصورة بملء الشاشة مع زر خروج فقط
         * @param {string} url - رابط الصورة
         * @param {string} title - عنوان الصورة
         */
        function viewImageFullscreen(url, title) {
            const viewer = document.createElement('div');
            viewer.className = 'pure-fullscreen-viewer';
            viewer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10000;';
            
            // إنشاء محتوى العارض بملء الشاشة
            viewer.innerHTML = `
                <button class="close-btn" style="position: fixed; top: 20px; right: 20px; background-color: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9999;">
                    <i class="fas fa-times"></i>
                </button>
                
                <img src="${url}" alt="${title}" style="max-width: 95%; max-height: 95vh; object-fit: contain; border-radius: 4px; box-shadow: 0 5px 25px rgba(0,0,0,0.5);" />
            `;
            
            document.body.appendChild(viewer);
            
            // إضافة مستمع لإغلاق العارض
            viewer.querySelector('.close-btn').addEventListener('click', function() {
                viewer.remove();
            });
            
            // إغلاق العارض عند النقر خارج الصورة
            viewer.addEventListener('click', function(e) {
                if (e.target === viewer) {
                    viewer.remove();
                }
            });
            
            // إغلاق العارض عند الضغط على مفتاح Escape
            document.addEventListener('keydown', function escapeFn(e) {
                if (e.key === 'Escape') {
                    viewer.remove();
                    document.removeEventListener('keydown', escapeFn); // إزالة المستمع
                }
            });
        }
        
        // وظيفة داخلية لاستخراج اسم الملف من URL
        function getFilenameFromUrl(url) {
            try {
                const urlObj = new URL(url);
                const pathname = urlObj.pathname;
                const segments = pathname.split('/');
                const filename = segments[segments.length - 1];
                
                // تنظيف الاسم من المعلمات
                return filename.split('?')[0] || 'image.jpg';
            } catch (e) {
                // في حالة الخطأ، نرجع اسم افتراضي
                return 'image.jpg';
            }
        }
        
        // تسجيل مشاهدة الصورة للإحصائيات
        function recordViewStats() {
            if (typeof recordImageView === 'function') {
                recordImageView();
            }
        }
        
        // إضافة وظيفة getFileNameFromUrl لدعم التنزيل
        if (typeof window.getFilenameFromUrl !== 'function') {
            window.getFilenameFromUrl = function(url) {
                try {
                    // استخراج الجزء الأخير من الرابط
                    let filename = url.split('/').pop().split(/[?#]/)[0];
                    
                    // التحقق من وجود امتداد صالح
                    const validExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.webp'];
                    const hasValidExtension = validExtensions.some(ext => 
                      filename.toLowerCase().includes(ext)
                    );
                    
                    // إضافة امتداد إذا لم يكن موجوداً
                    if (!hasValidExtension) {
                      if (url.includes('.png') || url.includes('png=')) {
                        filename += '.png';
                      } else if (url.includes('.gif') || url.includes('gif=')) {
                        filename += '.gif';
                      } else if (url.includes('.webp') || url.includes('webp=')) {
                        filename += '.webp';
                      } else {
                        filename += '.jpg'; // افتراضي
                      }
                    }
                    
                    // تنقية اسم الملف من الأحرف غير المسموحة
                    filename = filename.replace(/[^a-z0-9_.-]/gi, '_');
                    
                    // التحقق من صحة اسم الملف
                    if (!filename || filename.length < 3 || filename === '.jpg' || filename === '_.jpg') {
                      const timestamp = Date.now();
                      const typeHint = url.includes('leonardo.ai') ? 'leonardo_' : 'image_';
                      filename = `${typeHint}${timestamp}.jpg`;
                    }
                    
                    return filename;
                } catch (e) {
                    console.error('خطأ في استخراج اسم الملف:', e);
                    return `image_${Date.now()}.jpg`;
                }
            };
        }
        
        // وظيفة البديلة للتنزيل في حال فشل الدالة من ImageDownloader.js
        if (typeof window.downloadImage !== 'function') {
            window.downloadImage = function(event, url) {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                console.log('استخدام وظيفة التنزيل البديلة');
                
                try {
                    // استخراج اسم الملف من URL
                    const filename = window.getFilenameFromUrl ? window.getFilenameFromUrl(url) : url.substring(url.lastIndexOf('/') + 1);
                    
                    // إنشاء عنصر الرابط
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    
                    // إضافة الرابط إلى المستند وتنفيذ النقر
                    document.body.appendChild(link);
                    link.click();
                    
                    // إزالة الرابط بعد التنزيل
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 100);
                    
                    // تسجيل إحصائيات التنزيل
                    if (typeof recordImageDownload === 'function') {
                        recordImageDownload();
                    }
                    
                    return true;
                } catch (error) {
                    console.error('خطأ في تنزيل الصورة:', error);
                    alert('حدث خطأ أثناء محاولة تنزيل الصورة. يرجى المحاولة مرة أخرى لاحقاً.');
                    return false;
                }
            };
        }
        
        // إضافة مستمع البحث البسيط
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            
            if (searchInput) {
                // مستمع للكتابة في حقل البحث
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.trim().toLowerCase();
                    
                    // تطبيق البحث
                    searchGallery(searchTerm);
                });
                
                // مستمع لأيقونة البحث
                const searchIcon = document.querySelector('.search-icon');
                if (searchIcon) {
                    searchIcon.addEventListener('click', function() {
                        searchInput.focus();
                    });
                }
            }
        }
        
        // البحث في المعرض
        function searchGallery(searchTerm) {
            console.log('البحث عن:', searchTerm);
            
            // التحقق من حالة ربط البحث مع المرشحات
            const isLinked = window.isSearchLinked ? window.isSearchLinked() : true;
            
            // إذا كان مصطلح البحث فارغًا، استعد جميع الصور وطبق الفلاتر الحالية
            if (!searchTerm) {
                // إعادة تعيين فلتر البحث وتطبيق الفلاتر العادية
                window.searchFilter = null;
                
                // تطبيق الفلاتر الحالية
                applyFilters();
                refreshMasonry();
                return;
            }
            
            // تهيئة مجموعة العناصر المخفية إذا لم تكن موجودة
            if (!window.hiddenItems) {
                window.hiddenItems = new Set();
            }
            
            // حفظ فلتر البحث للاستخدام في وظائف أخرى
            window.searchFilter = searchTerm;
            
            const gridItems = document.querySelectorAll('.grid-item');
            let found = false;
            
            gridItems.forEach(item => {
                // الحصول على معرف العنصر
                const itemId = item.getAttribute('data-id') || item.id || item.dataset.url || Math.random().toString(36).substring(2, 15);
                
                // تأكد من أن العنصر له معرف
                if (!item.getAttribute('data-id')) {
                    item.setAttribute('data-id', itemId);
                }
                
                // جمع البيانات للبحث
                const title = item.getAttribute('data-title')?.toLowerCase() || '';
                const category = item.getAttribute('data-category')?.toLowerCase() || '';
                const tags = item.getAttribute('data-tags')?.toLowerCase() || '';
                
                // البحث في عنوان الصورة
                const titleElement = item.querySelector('.image-title-badge');
                const titleText = titleElement ? titleElement.textContent.toLowerCase() : '';
                
                // البحث في فئة الصورة
                const categoryElement = item.querySelector('.category-badge');
                const categoryText = categoryElement ? categoryElement.textContent.toLowerCase() : '';
                
                // جمع كل النصوص للبحث فيها
                const searchableText = `${title} ${category} ${tags} ${titleText} ${categoryText}`;
                
                const match = searchableText.includes(searchTerm);
                
                // التحقق من المرشحات النشطة
                let categoryMatch = true;
                let dimensionMatch = true;
                
                // فحص مرشح الفئة (فقط إذا كان الربط مفعل)
                if (isLinked && window.currentCategoryFilter && window.currentCategoryFilter !== 'all') {
                    categoryMatch = category === window.currentCategoryFilter;
                }
                
                // فحص مرشح الأبعاد (دائماً - سواء كان الربط مفعل أو مطفئ)
                if (window.currentDimensionFilter && window.currentDimensionFilter !== 'all') {
                    const itemDimension = item.getAttribute('data-dimension') || '';
                    dimensionMatch = itemDimension === window.currentDimensionFilter;
                }
                
                // العنصر يظهر إذا تطابق مع البحث وأبعاد الصورة، ومع الفئة فقط إذا كان الربط مفعل
                const shouldShow = match && dimensionMatch && categoryMatch;
                
                // تحديث حالة العنصر في مجموعة العناصر المخفية
                if (shouldShow) {
                    found = true;
                    window.hiddenItems.delete(itemId);
                    applyItemVisibility(item, true);
                } else {
                    window.hiddenItems.add(itemId);
                    applyItemVisibility(item, false);
                }
            });
            
            // تحديث تخطيط Masonry
            refreshMasonry();
        }
        
        // استدعاء وظيفة التهيئة للبحث
        initSearch();
        
        // تحديث نص شريط البحث حسب اللغة الحالية
        updateSearchPlaceholder();
        
        // وظيفة استعادة وضع العرض والفلاتر (مرتبطة بالتخزين المحلي)
        function restoreViewMode() {
            // استعادة وضع العرض المفضل
            const savedViewMode = localStorage.getItem('viewMode') || 'default';
            
            // استعادة الفلاتر المفضلة
            window.currentCategoryFilter = localStorage.getItem('currentCategoryFilter') || 'all';
            window.currentDimensionFilter = localStorage.getItem('currentDimensionFilter') || 'all';
            
            // إنشاء مجموعة العناصر المخفية
            if (!window.hiddenItems) {
                window.hiddenItems = new Set();
            }
            
            // تطبيق الوضع المحفوظ - مع تأخير بسيط لضمان تحميل الصفحة بشكل كامل
            setTimeout(() => {
                // تطبيق وضع العرض
                setGridColumns(savedViewMode);
                
                // تحديث أزرار الفلاتر النشطة
                try {
                    // تحديث أزرار الفئات
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    const categoryBtn = document.querySelector(`.filter-btn[data-category="${window.currentCategoryFilter}"]`);
                    if (categoryBtn) categoryBtn.classList.add('active');
                    
                    // تحديث أزرار الأبعاد
                    document.querySelectorAll('.dimension-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    const dimensionBtn = document.querySelector(`.dimension-btn[data-dimension="${window.currentDimensionFilter}"]`);
                    if (dimensionBtn) dimensionBtn.classList.add('active');
                } catch (e) {
                    console.error('خطأ في تحديث أزرار الفلاتر:', e);
                }
                
                // تطبيق الفلاتر
                applyFilters();
                
                // تأكيد إعادة تطبيق التنسيق الصحيح بعد وقت أطول
                setTimeout(() => {
                    refreshMasonry();
                }, 300);
            }, 200);
        }
        
        /**
         * الحصول على نوع أبعاد الصورة (طولي، عرضي، مربع)
         * @param {HTMLImageElement} img - عنصر الصورة
         * @returns {string} نوع البعد ('portrait', 'landscape', 'square')
         */
        function getImageDimensionType(img) {
            const width = img.naturalWidth || img.width || 0;
            const height = img.naturalHeight || img.height || 0;
            
            if (width && height) {
                const ratio = width / height;
                
                if (ratio < 0.9) {
                    return 'portrait';  // طولي
                } else if (ratio > 1.1) {
                    return 'landscape'; // عرضي
                } else {
                    return 'square';   // مربع
                }
            }
            
            return 'square'; // افتراضي إذا لم نتمكن من الحصول على الأبعاد
        }
        
        // دالة تحديد سمة الأبعاد لجميع الصور في المعرض
        function setDimensionAttributesForAllImages() {
            console.log("جاري تحديد أبعاد الصور...");
            const gridItems = document.querySelectorAll('.grid-item');
            gridItems.forEach(item => {
                if (!item.hasAttribute('data-dimension')) {
                    const img = item.querySelector('img');
                    if (img && img.complete) {
                        const dimension = getImageDimensionType(img);
                        item.setAttribute('data-dimension', dimension);
                        console.log("تم تحديد بعد الصورة:", img.alt || 'صورة بدون عنوان', dimension);
                    } else if (img) {
                        // إذا لم تكن الصورة محملة، انتظر حتى تكتمل
                        img.onload = function() {
                            const dimension = getImageDimensionType(img);
                            item.setAttribute('data-dimension', dimension);
                            console.log("تم تحديد بعد الصورة بعد التحميل:", img.alt || 'صورة بدون عنوان', dimension);
                        };
                    }
                }
            });
        }
        
        /**
         * تحديث مظهر زر الوضع العريض حسب حجم الشاشة
         */
        function updateWideViewButtonState() {
            const wideViewBtn = document.getElementById('wideViewBtn');
            const disabledIcon = wideViewBtn ? wideViewBtn.querySelector('.mobile-disabled-icon') : null;
            
            if (!wideViewBtn || !disabledIcon) return;
            
            const screenWidth = window.innerWidth;
            
            if (screenWidth <= 768) {
                // في الشاشات الصغيرة: إظهار أيقونة التعطيل بشكل دائم مع خلفية باهتة
                disabledIcon.style.display = 'block';
                disabledIcon.style.color = '#ff6b6b'; // لون زاهي للأيقونة
                disabledIcon.style.opacity = '1'; // تأكد من الظهور الكامل
                wideViewBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.1)'; // خلفية باهتة
                wideViewBtn.style.opacity = '0.5';
                wideViewBtn.style.cursor = 'not-allowed';
                wideViewBtn.classList.add('disabled-mobile');
            } else {
                // في الشاشات المتوسطة والكبيرة: إخفاء أيقونة التعطيل وتفعيل الزر
                disabledIcon.style.display = 'none';
                wideViewBtn.style.backgroundColor = ''; // إعادة تعيين الخلفية
                wideViewBtn.style.opacity = '1';
                wideViewBtn.style.cursor = 'pointer';
                wideViewBtn.classList.remove('disabled-mobile');
            }
        }

        // استعادة وضع العرض عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            restoreViewMode();
            
            // تحديث حالة زر الوضع العريض
            updateWideViewButtonState();
            
            // تحديد أبعاد الصور بعد تحميل الصفحة
            setTimeout(setDimensionAttributesForAllImages, 1000);
        });
        
        // تحديث حالة زر الوضع العريض عند تغيير حجم النافذة
        window.addEventListener('resize', function() {
            updateWideViewButtonState();
        });
        
        /**
         * تحديث واجهة المستخدم بناءً على حالة المصادقة
         */
        function updateAuthUI() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            
            if (currentUser && currentUser.username) {
                userName.textContent = currentUser.username;
                
                // تحديث البريد الإلكتروني إذا كان متوفرًا
                if (currentUser.email) {
                    userEmail.textContent = currentUser.email;
                } else {
                    userEmail.textContent = 'user@example.com';
                }
                
                // تحديث صورة المستخدم إذا كانت متوفرة
                const userAvatar = document.getElementById('user-avatar');
                const savedAvatar = localStorage.getItem('userAvatar');
                if (savedAvatar) {
                    userAvatar.src = savedAvatar;
                }
                
                // تحديث إحصائيات المستخدم
                updateUserStats();
            } else {
                userName.textContent = 'زائر';
                userEmail.textContent = 'guest@example.com';
            }
        }
        
        /**
         * تبديل عرض/إخفاء القائمة المنسدلة للمستخدم
         */
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown-menu');
            const icon = document.getElementById('user-dropdown-icon');
            
            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                
                // إضافة مستمع حدث للنقر خارج القائمة لإغلاقها
                setTimeout(() => {
                    document.addEventListener('click', closeUserMenuOnClickOutside);
                }, 10);
            } else {
                dropdown.style.display = 'none';
                icon.style.transform = 'rotate(0)';
                document.removeEventListener('click', closeUserMenuOnClickOutside);
            }
        }
        
        /**
         * إغلاق القائمة المنسدلة للمستخدم عند النقر خارجها
         */
        function closeUserMenuOnClickOutside(event) {
            const userInfo = document.getElementById('user-info');
            const dropdown = document.getElementById('user-dropdown-menu');
            
            if (!userInfo.contains(event.target)) {
                dropdown.style.display = 'none';
                document.getElementById('user-dropdown-icon').style.transform = 'rotate(0)';
                document.removeEventListener('click', closeUserMenuOnClickOutside);
            }
        }
        
        /**
         * تسجيل الخروج من الحساب
         */
        function logout() {
            // إزالة بيانات المستخدم من التخزين المحلي
            localStorage.removeItem('currentUser');
            
            // تحديث واجهة المستخدم
            updateAuthUI();
            
            // إعادة توجيه المستخدم إلى الصفحة الرئيسية
            window.location.href = 'simple-gallery.html';
        }
        
        /**
         * تحديث واجهة المستخدم مع الترجمات
         */
        function updateUILanguage() {
            const currentLang = localStorage.getItem('language') || 'ar';
            
            // قاموس الترجمات الموحد
            const translations = {
                settings: { ar: 'الإعدادات', en: 'Settings' },
                logout: { ar: 'تسجيل الخروج', en: 'Logout' },
                favCount: { ar: 'مفضلة', en: 'Favorites' },
                likeCount: { ar: 'إعجاب', en: 'Likes' },
                myAccount: { ar: 'حسابي', en: 'My Account' },
                home: { ar: 'الصفحة الرئيسية', en: 'Home' },
                myProfile: { ar: 'الملف الشخصي', en: 'My Profile' },
                myFavorites: { ar: 'المفضلة', en: 'My Favorites' },
                language: { ar: 'اللغة', en: 'Language' },
                imageDimensions: { ar: 'أبعاد الصور', en: 'Image Dimensions' },
                viewMode: { ar: 'طريقة العرض', en: 'View Mode' },
                tools: { ar: 'أدوات', en: 'Tools' },
                // ترجمات أزرار الفئات
                allImages: { ar: 'جميع الصور', en: 'All Images' },
                animals: { ar: 'حيوانات', en: 'Animals' },
                anime: { ar: 'أنمي', en: 'Anime' },
                creativity: { ar: 'إبداع', en: 'Creativity' },
                technology: { ar: 'تكنولوجيا', en: 'Technology' },
                world: { ar: 'عالم', en: 'World' },
                space: { ar: 'فضاء', en: 'Space' },
                classic: { ar: 'كلاسيكي', en: 'Classic' }
            };
            
            // تحديث جميع العناصر التي تحتوي على سمة data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[key] && translations[key][currentLang]) {
                    // التحقق من وجود عنصر category-text بداخل العنصر (للأزرار المركبة)
                    const categoryTextElement = element.querySelector('.category-text');
                    if (categoryTextElement) {
                        categoryTextElement.textContent = translations[key][currentLang];
                    } else {
                        // للعناصر البسيطة
                        element.textContent = translations[key][currentLang];
                    }
                }
            });
        }

        /**
         * تبديل اللغة مع تحديث شامل للواجهة
         */
        function switchLanguage(lang) {
            console.log('تبديل اللغة إلى:', lang);
            
            // تخزين اللغة
            localStorage.setItem('language', lang);
            
            // تحديث اتجاه الصفحة
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // تحديث حالة أزرار اللغة
            document.querySelectorAll('.lang-option').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-lang') === lang) {
                    option.classList.add('active');
                }
            });
            
            // تحديث كروت الصور بعد تغيير اللغة
            updateImageCardsLanguage();
            
            // تطبيق الترجمات فوراً
            updateUILanguage();
        }

        /**
         * تحديث كروت الصور عند تغيير اللغة
         */
        function updateImageCardsLanguage() {
            const currentLang = localStorage.getItem('language') || 'ar';
            const gridItems = document.querySelectorAll('.grid-item');
            
            gridItems.forEach((item, index) => {
                // العثور على بيانات الصورة المقابلة
                const imageData = window.imageData[index];
                if (!imageData) return;
                
                // تحديث عنوان الصورة
                const titleElement = item.querySelector('.image-title-badge');
                if (titleElement && imageData.title) {
                    let newTitle;
                    if (typeof imageData.title === 'object') {
                        newTitle = imageData.title[currentLang] || 
                                  imageData.title.ar || 
                                  imageData.title.en || 
                                  imageData.alt || 
                                  'صورة';
                    } else {
                        newTitle = imageData.title || imageData.alt || 'صورة';
                    }
                    titleElement.textContent = newTitle;
                    titleElement.title = newTitle;
                }
                
                // تحديث فئة الصورة
                const categoryElement = item.querySelector('.category-badge');
                if (categoryElement && imageData.category) {
                    let newCategory;
                    if (typeof imageData.category === 'object') {
                        newCategory = imageData.category[currentLang] || 
                                     imageData.category.ar || 
                                     imageData.category.en || 
                                     imageData.category;
                    } else {
                        // ترجمة الفئات الأساسية
                        const categoryTranslations = {
                            'creativity': currentLang === 'ar' ? 'إبداع' : 'Creativity',
                            'animals': currentLang === 'ar' ? 'حيوانات' : 'Animals',
                            'space': currentLang === 'ar' ? 'فضاء' : 'Space',
                            'technology': currentLang === 'ar' ? 'تكنولوجيا' : 'Technology',
                            'nature': currentLang === 'ar' ? 'طبيعة' : 'Nature',
                            'anime': currentLang === 'ar' ? 'أنمي' : 'Anime',
                            'world': currentLang === 'ar' ? 'عالم' : 'World',
                            'classic': currentLang === 'ar' ? 'كلاسيكي' : 'Classic',
                            'birds': currentLang === 'ar' ? 'طيور' : 'Birds',
                            'general': currentLang === 'ar' ? 'عام' : 'General'
                        };
                        
                        const categoryLower = imageData.category.toLowerCase();
                        newCategory = categoryTranslations[categoryLower] || imageData.category;
                    }
                    categoryElement.textContent = newCategory;
                }
            });
            
            // تحديث نص شريط البحث
            updateSearchPlaceholder();
        }

        /**
         * تحديث نص شريط البحث حسب اللغة المختارة
         */
        function updateSearchPlaceholder() {
            const currentLang = localStorage.getItem('language') || 'ar';
            const searchInput = document.getElementById('searchInput');
            
            if (searchInput) {
                const placeholderTexts = {
                    'ar': 'ابحث عن اسم صورة...',
                    'en': 'Search for image name...'
                };
                
                searchInput.placeholder = placeholderTexts[currentLang] || placeholderTexts['ar'];
            }
            
            // إغلاق القوائم
            const standardMenu = document.getElementById('languageMenu');
            const indexMenu = document.getElementById('indexLanguageMenu');
            
            if (standardMenu) {
                standardMenu.classList.remove('show');
                standardMenu.style.display = 'none';
            }
            
            if (indexMenu) {
                indexMenu.style.display = 'none';
            }
            
            // استدعاء دالة تحديث واجهة المستخدم من الملفات الخارجية إذا وجدت
            if (typeof window.updateUILanguage === 'function' && window.updateUILanguage !== updateUILanguage) {
                try {
                    window.updateUILanguage();
                } catch (e) {
                    console.error('خطأ في استدعاء دالة تحديث واجهة المستخدم الخارجية:', e);
                }
            }
        }

        /**
         * فتح نافذة الإعدادات
         */
        function openSettings() {
            // إغلاق القائمة المنسدلة للمستخدم إذا كانت مفتوحة
            const dropdown = document.getElementById('user-dropdown-menu');
            if (dropdown && dropdown.style.display === 'block') {
                toggleUserMenu();
            }
            
            // عرض مربع حوار الإعدادات
            showSettingsDialog();
        }
        
        /**
         * عرض مربع حوار الإعدادات
         */
        function showSettingsDialog() {
            // الحصول على اللغة الحالية
            const currentLang = localStorage.getItem('language') || 'ar';
            const isRTL = currentLang === 'ar';
            
            // تحديد النصوص حسب اللغة
            const texts = currentLang === 'en' ? {
                title: 'Settings',
                user: 'User',
                account: 'Account',
                username: 'Username',
                save: 'Save Changes',
                logout: 'Logout',
                deleteAccount: 'Delete Account',
                deleteConfirm: 'Are you sure you want to delete your account?',
                yes: 'Yes',
                no: 'No',
                close: 'Close'
            } : {
                title: 'الإعدادات',
                user: 'المستخدم',
                account: 'الحساب',
                username: 'اسم المستخدم',
                save: 'حفظ التغييرات',
                logout: 'تسجيل الخروج',
                deleteAccount: 'حذف الحساب',
                deleteConfirm: 'هل أنت متأكد من رغبتك في حذف حسابك؟',
                yes: 'نعم',
                no: 'لا',
                close: 'إغلاق'
            };
            
            // الحصول على بيانات المستخدم الحالي
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const username = currentUser.username || 'زائر';
            
            // إنشاء عنصر الخلفية
            const settingsOverlay = document.createElement('div');
            settingsOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            `;
            
            // إنشاء مربع الإعدادات
            const settingsBox = document.createElement('div');
            settingsBox.style.cssText = `
                background: linear-gradient(135deg, rgba(20, 20, 35, 0.98), rgba(35, 35, 50, 0.98));
                border: 2px solid rgba(100, 100, 150, 0.4);
                border-radius: 20px;
                width: 90%;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                overflow-x: hidden;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                direction: ltr;
                position: relative;
                backdrop-filter: blur(15px);
            `;
            
            // إنشاء رأس مربع الحوار مع زر الإغلاق (ثابت ولا يتأثر بتغيير اللغة)
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 25px 30px;
                border-bottom: 2px solid rgba(80, 80, 120, 0.4);
                background: linear-gradient(90deg, rgba(50, 50, 70, 0.2), rgba(60, 60, 80, 0.2));
                border-radius: 20px 20px 0 0;
                position: sticky;
                top: 0;
                z-index: 10;
            `;
            
            // إنشاء العنوان (ثابت ولا يتأثر بتغيير اللغة)
            const title = document.createElement('h2');
            title.textContent = texts.title;
            title.style.cssText = `
                color: #b0c4ff;
                margin: 0;
                font-size: 26px;
                font-weight: bold;
                text-shadow: 0 2px 8px rgba(176, 196, 255, 0.4);
                position: relative;
                z-index: 1;
            `;
            
            // إنشاء زر الإغلاق (X)
            const closeX = document.createElement('button');
            closeX.innerHTML = '&times;';
            closeX.style.cssText = `
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.7);
                font-size: 28px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: color 0.3s;
            `;
            
            closeX.addEventListener('mouseenter', () => {
                closeX.style.color = 'white';
            });
            
            closeX.addEventListener('mouseleave', () => {
                closeX.style.color = 'rgba(255, 255, 255, 0.7)';
            });
            
            closeX.addEventListener('click', () => {
                document.body.removeChild(settingsOverlay);
            });
            
            header.appendChild(title);
            header.appendChild(closeX);
            
            // إنشاء قسم التنقل (العلامات التبويبية)
            const tabsContainer = document.createElement('div');
            tabsContainer.style.cssText = `
                display: flex;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 0 25px;
            `;
            
            const tabs = [
                { id: 'user-tab', text: texts.user, active: true },
                { id: 'account-tab', text: texts.account, active: false }
            ];
            
            // إنشاء العلامات التبويبية
            tabs.forEach(tab => {
                const tabElement = document.createElement('div');
                tabElement.id = tab.id;
                tabElement.textContent = tab.text;
                tabElement.style.cssText = `
                    padding: 15px 20px;
                    color: ${tab.active ? 'white' : 'rgba(255, 255, 255, 0.7)'};
                    cursor: pointer;
                    position: relative;
                    font-weight: ${tab.active ? 'bold' : 'normal'};
                    transition: color 0.3s;
                `;
                
                // إضافة الشريط السفلي للعلامة النشطة
                if (tab.active) {
                    tabElement.style.cssText += `
                        &::after {
                            content: '';
                            position: absolute;
                            bottom: -1px;
                            left: 0;
                            width: 100%;
                            height: 3px;
                            background: linear-gradient(to right, #b44ccc, #9966ff);
                            border-radius: 3px 3px 0 0;
                        }
                    `;
                }
                
                // إضافة وظيفة النقر لتبديل بين العلامات
                tabElement.addEventListener('click', () => {
                    // تبديل المحتوى
                    if (tab.id === 'user-tab') {
                        document.getElementById('user-content').style.display = 'block';
                        document.getElementById('account-content').style.display = 'none';
                        document.getElementById('user-tab').style.color = 'white';
                        document.getElementById('user-tab').style.fontWeight = 'bold';
                        document.getElementById('account-tab').style.color = 'rgba(255, 255, 255, 0.7)';
                        document.getElementById('account-tab').style.fontWeight = 'normal';
                    } else {
                        document.getElementById('user-content').style.display = 'none';
                        document.getElementById('account-content').style.display = 'block';
                        document.getElementById('account-tab').style.color = 'white';
                        document.getElementById('account-tab').style.fontWeight = 'bold';
                        document.getElementById('user-tab').style.color = 'rgba(255, 255, 255, 0.7)';
                        document.getElementById('user-tab').style.fontWeight = 'normal';
                    }
                });
                
                tabsContainer.appendChild(tabElement);
            });
            
            // إنشاء محتوى قسم المستخدم
            const userContent = document.createElement('div');
            userContent.id = 'user-content';
            userContent.style.cssText = `
                padding: 25px;
                display: block;
            `;
            
            // حقل اسم المستخدم
            const usernameField = document.createElement('div');
            usernameField.style.cssText = `
                margin-bottom: 20px;
            `;
            
            const usernameLabel = document.createElement('label');
            usernameLabel.textContent = texts.username;
            usernameLabel.style.cssText = `
                display: block;
                margin-bottom: 8px;
                color: rgba(255, 255, 255, 0.9);
                font-size: 14px;
            `;
            
            const usernameInput = document.createElement('input');
            usernameInput.type = 'text';
            usernameInput.value = username;
            usernameInput.id = 'username-input';
            usernameInput.style.cssText = `
                width: 100%;
                padding: 12px 15px;
                background: rgba(0, 0, 0, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 8px;
                color: white;
                font-size: 16px;
                box-sizing: border-box;
                transition: border-color 0.3s;
            `;
            
            usernameInput.addEventListener('focus', () => {
                usernameInput.style.borderColor = 'rgba(180, 76, 204, 0.5)';
            });
            
            usernameInput.addEventListener('blur', () => {
                usernameInput.style.borderColor = 'rgba(255, 255, 255, 0.15)';
            });
            
            usernameField.appendChild(usernameLabel);
            usernameField.appendChild(usernameInput);
            
            // زر حفظ التغييرات
            const saveButton = document.createElement('button');
            saveButton.textContent = texts.save;
            saveButton.style.cssText = `
                background: linear-gradient(45deg, #9c65a3, #ba7fc2);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 12px 15px;
                font-size: 16px;
                width: 100%;
                cursor: pointer;
                transition: all 0.3s;
            `;
            
            saveButton.addEventListener('mouseenter', () => {
                saveButton.style.background = 'linear-gradient(45deg, #b279b9, #c98dd1)';
            });
            
            saveButton.addEventListener('mouseleave', () => {
                saveButton.style.background = 'linear-gradient(45deg, #9c65a3, #ba7fc2)';
            });
            
            saveButton.addEventListener('click', () => {
                const newUsername = document.getElementById('username-input').value.trim();
                
                if (newUsername) {
                    // تحديث اسم المستخدم في التخزين المحلي
                    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    user.username = newUsername;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    // تحديث واجهة المستخدم
                    document.getElementById('user-name').textContent = newUsername;
                    
                    // عرض رسالة نجاح
                    const successMsg = document.createElement('div');
                    successMsg.textContent = currentLang === 'en' ? 'Username updated successfully!' : 'تم تحديث اسم المستخدم بنجاح!';
                    successMsg.style.cssText = `
                        color: #4caf50;
                        background: rgba(76, 175, 80, 0.1);
                        padding: 10px;
                        border-radius: 5px;
                        margin-top: 10px;
                        text-align: center;
                    `;
                    
                    // إضافة الرسالة وإزالتها بعد 3 ثوان
                    if (!document.getElementById('success-message')) {
                        successMsg.id = 'success-message';
                        userContent.appendChild(successMsg);
                        
                        setTimeout(() => {
                            if (document.getElementById('success-message')) {
                                userContent.removeChild(successMsg);
                            }
                        }, 3000);
                    }
                }
            });
            
            userContent.appendChild(usernameField);
            userContent.appendChild(saveButton);
            
            // إنشاء محتوى قسم الحساب
            const accountContent = document.createElement('div');
            accountContent.id = 'account-content';
            accountContent.style.cssText = `
                padding: 25px;
                display: none;
            `;
            
            // زر تسجيل الخروج
            const logoutButton = document.createElement('button');
            logoutButton.textContent = texts.logout;
            logoutButton.style.cssText = `
                background: rgba(0, 0, 0, 0.3);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 8px;
                padding: 12px 15px;
                font-size: 16px;
                width: 100%;
                cursor: pointer;
                margin-bottom: 15px;
                transition: all 0.3s;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            // أيقونة تسجيل الخروج
            const logoutIcon = document.createElement('i');
            logoutIcon.className = 'fas fa-sign-out-alt';
            logoutIcon.style.cssText = `
                margin-${isRTL ? 'left' : 'right'}: 10px;
                font-size: 16px;
            `;
            
            logoutButton.prepend(logoutIcon);
            
            logoutButton.addEventListener('mouseenter', () => {
                logoutButton.style.background = 'rgba(0, 0, 0, 0.4)';
            });
            
            logoutButton.addEventListener('mouseleave', () => {
                logoutButton.style.background = 'rgba(0, 0, 0, 0.3)';
            });
            
            logoutButton.addEventListener('click', () => {
                logout();
            });
            
            // زر حذف الحساب
            const deleteButton = document.createElement('button');
            deleteButton.textContent = texts.deleteAccount;
            deleteButton.style.cssText = `
                background: rgba(244, 67, 54, 0.1);
                color: #f44336;
                border: 1px solid rgba(244, 67, 54, 0.3);
                border-radius: 8px;
                padding: 12px 15px;
                font-size: 16px;
                width: 100%;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            // أيقونة حذف الحساب
            const deleteIcon = document.createElement('i');
            deleteIcon.className = 'fas fa-trash-alt';
            deleteIcon.style.cssText = `
                margin-${isRTL ? 'left' : 'right'}: 10px;
                font-size: 16px;
            `;
            
            deleteButton.prepend(deleteIcon);
            
            deleteButton.addEventListener('mouseenter', () => {
                deleteButton.style.background = 'rgba(244, 67, 54, 0.2)';
            });
            
            deleteButton.addEventListener('mouseleave', () => {
                deleteButton.style.background = 'rgba(244, 67, 54, 0.1)';
            });
            
            deleteButton.addEventListener('click', () => {
                // عرض مربع حوار تأكيد الحذف
                if (confirm(texts.deleteConfirm)) {
                    // حذف بيانات المستخدم
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('userAvatar');
                    localStorage.removeItem('favorites');
                    localStorage.removeItem('userLikes');
                    
                    // تحديث واجهة المستخدم
                    updateAuthUI();
                    
                    // إغلاق نافذة الإعدادات
                    document.body.removeChild(settingsOverlay);
                    
                    // إعادة توجيه المستخدم إلى الصفحة الرئيسية
                    window.location.href = 'simple-gallery.html';
                }
            });
            
            accountContent.appendChild(logoutButton);
            accountContent.appendChild(deleteButton);
            
            // تجميع جميع العناصر في مربع الإعدادات
            settingsBox.appendChild(header);
            settingsBox.appendChild(tabsContainer);
            settingsBox.appendChild(userContent);
            settingsBox.appendChild(accountContent);
            
            settingsOverlay.appendChild(settingsBox);
            
            // إضافة مربع الإعدادات إلى الصفحة
            document.body.appendChild(settingsOverlay);
            
            // إغلاق مربع الإعدادات عند النقر خارجه
            settingsOverlay.addEventListener('click', (e) => {
                if (e.target === settingsOverlay) {
                    document.body.removeChild(settingsOverlay);
                }
            });
        }
        
        /**
         * تحديث إحصائيات المستخدم
         */
        function updateUserStats() {
            // الحصول على عدد المفضلة
            const favoritesElement = document.getElementById('favorites-count');
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            favoritesElement.textContent = favorites.length;
            
            // الحصول على عدد الإعجابات
            const likesElement = document.getElementById('likes-count');
            const userLikes = JSON.parse(localStorage.getItem('userLikes') || '[]');
            likesElement.textContent = userLikes.length;
        }
        
        // تعريف الدوال في النطاق العام لضمان الوصول إليها
        window.updateUILanguage = updateUILanguage;
        window.switchLanguage = switchLanguage;

        // تحديث واجهة المستخدم عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthUI();
            updateUILanguage(); // تطبيق الترجمات عند تحميل الصفحة
            
            // تطبيق اللغة المحفوظة
            const savedLang = localStorage.getItem('language') || 'ar';
            document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
        });


    </script>
</body>
</html>